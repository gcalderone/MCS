<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
<title>MCS: Readers.cc Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
<link href="tabs.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.5.3 -->
<script type="text/javascript">
<!--
function changeDisplayState (e){
  var num=this.id.replace(/[^[0-9]/g,'');
  var button=this.firstChild;
  var sectionDiv=document.getElementById('dynsection'+num);
  if (sectionDiv.style.display=='none'||sectionDiv.style.display==''){
    sectionDiv.style.display='block';
    button.src='open.gif';
  }else{
    sectionDiv.style.display='none';
    button.src='closed.gif';
  }
}
function initDynSections(){
  var divs=document.getElementsByTagName('div');
  var sectionCounter=1;
  for(var i=0;i<divs.length-1;i++){
    if(divs[i].className=='dynheader'&&divs[i+1].className=='dynsection'){
      var header=divs[i];
      var section=divs[i+1];
      var button=header.firstChild;
      if (button!='IMG'){
        divs[i].insertBefore(document.createTextNode(' '),divs[i].firstChild);
        button=document.createElement('img');
        divs[i].insertBefore(button,divs[i].firstChild);
      }
      header.style.cursor='pointer';
      header.onclick=changeDisplayState;
      header.id='dynheader'+sectionCounter;
      button.src='closed.gif';
      section.id='dynsection'+sectionCounter;
      section.style.display='none';
      sectionCounter++;
    }
  }
}
window.onload = initDynSections;
-->
</script>
<div class="tabs">
  <ul>
    <li><a href="main.html"><span>Main&nbsp;Page</span></a></li>
    <li><a href="namespaces.html"><span>Namespaces</span></a></li>
    <li><a href="classes.html"><span>Classes</span></a></li>
    <li class="current"><a href="files.html"><span>Files</span></a></li>
    <li><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
    <li>
      <form action="search.php" method="get">
        <table cellspacing="0" cellpadding="0" border="0">
          <tr>
            <td><label>&nbsp;<u>S</u>earch&nbsp;for&nbsp;</label></td>
            <td><input type="text" name="query" value="" size="20" accesskey="s"/></td>
          </tr>
        </table>
      </form>
    </li>
  </ul>
</div>
<h1>Readers.cc</h1><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">// ----------------------------------------------------------------------^</span>
<a name="l00002"></a>00002 <span class="comment">// Copyright (C) 2004, 2005, 2006, 2007, 2008 Giorgio Calderone</span>
<a name="l00003"></a>00003 <span class="comment">// (mailto: &lt;gcalderone@ifc.inaf.it&gt;)</span>
<a name="l00004"></a>00004 <span class="comment">// </span>
<a name="l00005"></a>00005 <span class="comment">// This file is part of MCS.</span>
<a name="l00006"></a>00006 <span class="comment">// </span>
<a name="l00007"></a>00007 <span class="comment">// MCS is free software; you can redistribute it and/or modify</span>
<a name="l00008"></a>00008 <span class="comment">// it under the terms of the GNU General Public License as published by</span>
<a name="l00009"></a>00009 <span class="comment">// the Free Software Foundation; either version 2 of the License, or</span>
<a name="l00010"></a>00010 <span class="comment">// (at your option) any later version.</span>
<a name="l00011"></a>00011 <span class="comment">// </span>
<a name="l00012"></a>00012 <span class="comment">// MCS is distributed in the hope that it will be useful,</span>
<a name="l00013"></a>00013 <span class="comment">// but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<a name="l00014"></a>00014 <span class="comment">// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<a name="l00015"></a>00015 <span class="comment">// GNU General Public License for more details.</span>
<a name="l00016"></a>00016 <span class="comment">// </span>
<a name="l00017"></a>00017 <span class="comment">// You should have received a copy of the GNU General Public License</span>
<a name="l00018"></a>00018 <span class="comment">// along with MCS; if not, write to the Free Software</span>
<a name="l00019"></a>00019 <span class="comment">// Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA  02110-1301  USA</span>
<a name="l00020"></a>00020 <span class="comment">// </span>
<a name="l00021"></a>00021 <span class="comment">// ----------------------------------------------------------------------$</span>
<a name="l00022"></a>00022 <span class="preprocessor">#include "<a class="code" href="mcs_8hh.html" title="Main include file for all MCS based applications.">mcs.hh</a>"</span>
<a name="l00023"></a>00023 <span class="keyword">using namespace </span>mcs;
<a name="l00024"></a>00024 
<a name="l00025"></a>00025 <span class="comment">//CURL includes</span>
<a name="l00026"></a>00026 <span class="preprocessor">#include &lt;curl/curl.h&gt;</span>
<a name="l00027"></a>00027 
<a name="l00028"></a>00028 <span class="comment">//CFITSIO include</span>
<a name="l00029"></a>00029 <span class="preprocessor">#if ENABLE_CFITSIO</span>
<a name="l00030"></a>00030 <span class="preprocessor"></span><span class="preprocessor">#include &lt;fitsio.h&gt;</span>
<a name="l00031"></a>00031 <span class="comment">//#include &lt;fstream&gt;</span>
<a name="l00032"></a>00032 <span class="preprocessor">#endif  //ENABLE_CFITSIO</span>
<a name="l00033"></a>00033 <span class="preprocessor"></span>
<a name="l00034"></a>00034 
<a name="l00035"></a>00035 <a class="code" href="classmcs_1_1Synchro.html" title="A simple class to implement &amp;quot;critical sections&amp;quot;.">Synchro</a> Pipe::synchro;
<a name="l00036"></a>00036 <span class="keywordtype">int</span> Pipe::filecount = 0;
<a name="l00037"></a>00037 
<a name="l00038"></a><a class="code" href="classmcs_1_1Pipe.html#91ddad07e89d5585b1cf27fa7860e201">00038</a> Pipe::Pipe()
<a name="l00039"></a>00039 {
<a name="l00040"></a>00040   <a class="code" href="classmcs_1_1Pipe.html#1ebe6d72d5c141fb3da0735f9ac74bca" title="Name of the FIFO file.">pipefn</a> = <span class="stringliteral">""</span>;
<a name="l00041"></a>00041   <a class="code" href="classmcs_1_1Pipe.html#41ff113cff7c9729cdcea8a32d5a78ea" title="Pipe file descriptors (0 read side, 1 write side).">pipefd</a>[0] = 0;
<a name="l00042"></a>00042   <a class="code" href="classmcs_1_1Pipe.html#41ff113cff7c9729cdcea8a32d5a78ea" title="Pipe file descriptors (0 read side, 1 write side).">pipefd</a>[1] = 0;
<a name="l00043"></a>00043   <a class="code" href="classmcs_1_1Pipe.html#95eb49fd6a565550a564ec3434e95e66" title="Tell if a pipe has been created.">flcreated</a> = <span class="keyword">false</span>;
<a name="l00044"></a>00044   <a class="code" href="classmcs_1_1Pipe.html#d3e7f4e7d08fd02cc37ad6d23d184440" title="If it is a named pipe (a FIFO file) or not.">named</a> = <span class="keyword">false</span>;
<a name="l00045"></a>00045 }
<a name="l00046"></a>00046 
<a name="l00047"></a><a class="code" href="classmcs_1_1Pipe.html#f4519cc3f1f13857a724db7b2220eefa">00047</a> <a class="code" href="classmcs_1_1Pipe.html#f4519cc3f1f13857a724db7b2220eefa" title="Destructor.">Pipe::~Pipe</a>()
<a name="l00048"></a>00048 {
<a name="l00049"></a>00049   <span class="comment">//Assume that is always the thread who reads from the pipe that</span>
<a name="l00050"></a>00050   <span class="comment">//manages the object creation/destruction</span>
<a name="l00051"></a>00051     <span class="comment">//closeRead();</span>
<a name="l00052"></a>00052 }
<a name="l00053"></a>00053 
<a name="l00054"></a><a class="code" href="classmcs_1_1Pipe.html#c1f3e6cca5d8a095d0d1fec8b215d565">00054</a> <span class="keywordtype">bool</span> <a class="code" href="classmcs_1_1Pipe.html#c1f3e6cca5d8a095d0d1fec8b215d565" title="Returns true if the pipe has been set-up (through the create() or createNamed() methods)...">Pipe::isReady</a>()
<a name="l00055"></a>00055 { <span class="keywordflow">return</span> <a class="code" href="classmcs_1_1Pipe.html#95eb49fd6a565550a564ec3434e95e66" title="Tell if a pipe has been created.">flcreated</a>; }
<a name="l00056"></a>00056 
<a name="l00057"></a><a class="code" href="classmcs_1_1Pipe.html#6af973eda513f30750bbbb87de746606">00057</a> <span class="keywordtype">string</span> <a class="code" href="classmcs_1_1Pipe.html#6af973eda513f30750bbbb87de746606" title="If the pipe has been set-up through the createNamed() method this returns the generated...">Pipe::filename</a>()
<a name="l00058"></a>00058 { <span class="keywordflow">return</span> <a class="code" href="classmcs_1_1Pipe.html#1ebe6d72d5c141fb3da0735f9ac74bca" title="Name of the FIFO file.">pipefn</a>; }
<a name="l00059"></a>00059 
<a name="l00060"></a>00060 
<a name="l00061"></a><a class="code" href="classmcs_1_1Pipe.html#82f77c903135c50afe7ec956142d832b">00061</a> <span class="keywordtype">bool</span> <a class="code" href="classmcs_1_1Pipe.html#82f77c903135c50afe7ec956142d832b" title="Tell if the consumer thread is still reading.">Pipe::consumerHasGone</a>()
<a name="l00062"></a>00062 {
<a name="l00063"></a>00063   <span class="keywordflow">if</span> (<a class="code" href="classmcs_1_1Pipe.html#41ff113cff7c9729cdcea8a32d5a78ea" title="Pipe file descriptors (0 read side, 1 write side).">pipefd</a>[1])
<a name="l00064"></a>00064     <span class="keywordflow">if</span> (<a class="code" href="namespacemcs.html#19a005a5a2a2d8a7d497ee0058490391">Select</a>(<a class="code" href="classmcs_1_1Pipe.html#41ff113cff7c9729cdcea8a32d5a78ea" title="Pipe file descriptors (0 read side, 1 write side).">pipefd</a>[1], 0, 1, <a class="code" href="mcs_8hh.html#9446251222278f804d0f1030f1fb40bb">MCS_SELECT_WRITE</a>) == -1)
<a name="l00065"></a>00065       <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00066"></a>00066 
<a name="l00067"></a>00067   <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00068"></a>00068 }
<a name="l00069"></a>00069 
<a name="l00070"></a>00070 
<a name="l00071"></a><a class="code" href="classmcs_1_1Pipe.html#3ebae63d960d5b772e287ab53e268b19">00071</a> <span class="keywordtype">void</span> <a class="code" href="classmcs_1_1Pipe.html#3ebae63d960d5b772e287ab53e268b19" title="Create an unnamed pipe, both threads will read/write using file descriptors.">Pipe::create</a>()
<a name="l00072"></a>00072 {
<a name="l00073"></a>00073   <span class="keywordflow">if</span> (<a class="code" href="classmcs_1_1Pipe.html#95eb49fd6a565550a564ec3434e95e66" title="Tell if a pipe has been created.">flcreated</a>)
<a name="l00074"></a>00074     <span class="keywordflow">throw</span> <a class="code" href="mcs_8hh.html#641a1a9e13c7a3ed2861f2572af8a3f4" title="Facility to easily pass all necessary parameter to an Event constructor.">MCS_ERROR</a>(MSG_PIPE_YET_OPENED);
<a name="l00075"></a>00075 
<a name="l00076"></a>00076   <span class="keywordflow">if</span> (<a class="code" href="classmcs_1_1Pipe.html#41ff113cff7c9729cdcea8a32d5a78ea" title="Pipe file descriptors (0 read side, 1 write side).">pipefd</a>[0] + <a class="code" href="classmcs_1_1Pipe.html#41ff113cff7c9729cdcea8a32d5a78ea" title="Pipe file descriptors (0 read side, 1 write side).">pipefd</a>[1])
<a name="l00077"></a>00077     <span class="keywordflow">throw</span> <a class="code" href="mcs_8hh.html#641a1a9e13c7a3ed2861f2572af8a3f4" title="Facility to easily pass all necessary parameter to an Event constructor.">MCS_ERROR</a>(MSG_PIPE_YET_OPENED);
<a name="l00078"></a>00078 
<a name="l00079"></a>00079   <span class="keywordflow">if</span> (pipe(<a class="code" href="classmcs_1_1Pipe.html#41ff113cff7c9729cdcea8a32d5a78ea" title="Pipe file descriptors (0 read side, 1 write side).">pipefd</a>) != 0)
<a name="l00080"></a>00080     <span class="keywordflow">throw</span> <a class="code" href="mcs_8hh.html#641a1a9e13c7a3ed2861f2572af8a3f4" title="Facility to easily pass all necessary parameter to an Event constructor.">MCS_ERROR</a>(MSG_CALLING_PIPE);
<a name="l00081"></a>00081 
<a name="l00082"></a>00082   <a class="code" href="classmcs_1_1Pipe.html#95eb49fd6a565550a564ec3434e95e66" title="Tell if a pipe has been created.">flcreated</a> = <span class="keyword">true</span>;
<a name="l00083"></a>00083   <a class="code" href="classmcs_1_1Pipe.html#d3e7f4e7d08fd02cc37ad6d23d184440" title="If it is a named pipe (a FIFO file) or not.">named</a> = <span class="keyword">false</span>;
<a name="l00084"></a>00084 }
<a name="l00085"></a>00085 
<a name="l00086"></a><a class="code" href="classmcs_1_1Pipe.html#bd5ece54f657e5583248542d5c11f77b">00086</a> <span class="keywordtype">string</span> <a class="code" href="classmcs_1_1Pipe.html#bd5ece54f657e5583248542d5c11f77b" title="Create a named pipe, that is a FIFO special file and returns the filename.">Pipe::createNamed</a>()
<a name="l00087"></a>00087 {
<a name="l00088"></a>00088   <span class="keywordtype">char</span> <a class="code" href="classmcs_1_1Pipe.html#6af973eda513f30750bbbb87de746606" title="If the pipe has been set-up through the createNamed() method this returns the generated...">filename</a>[20];
<a name="l00089"></a>00089 
<a name="l00090"></a>00090   <span class="keywordflow">if</span> (<a class="code" href="classmcs_1_1Pipe.html#95eb49fd6a565550a564ec3434e95e66" title="Tell if a pipe has been created.">flcreated</a>)
<a name="l00091"></a>00091     <span class="keywordflow">throw</span> <a class="code" href="mcs_8hh.html#641a1a9e13c7a3ed2861f2572af8a3f4" title="Facility to easily pass all necessary parameter to an Event constructor.">MCS_ERROR</a>(MSG_PIPE_YET_OPENED);
<a name="l00092"></a>00092 
<a name="l00093"></a>00093   <span class="keywordflow">if</span> (<a class="code" href="classmcs_1_1Pipe.html#41ff113cff7c9729cdcea8a32d5a78ea" title="Pipe file descriptors (0 read side, 1 write side).">pipefd</a>[0] + <a class="code" href="classmcs_1_1Pipe.html#41ff113cff7c9729cdcea8a32d5a78ea" title="Pipe file descriptors (0 read side, 1 write side).">pipefd</a>[1])
<a name="l00094"></a>00094     <span class="keywordflow">throw</span> <a class="code" href="mcs_8hh.html#641a1a9e13c7a3ed2861f2572af8a3f4" title="Facility to easily pass all necessary parameter to an Event constructor.">MCS_ERROR</a>(MSG_PIPE_YET_OPENED);
<a name="l00095"></a>00095 
<a name="l00096"></a>00096   <span class="keywordflow">do</span> {
<a name="l00097"></a>00097     <span class="comment">/*</span>
<a name="l00098"></a>00098 <span class="comment">      Due to the fact that a Pipe object is typically used by two</span>
<a name="l00099"></a>00099 <span class="comment">      concurrent threads, and that the FIFO file is not open just as</span>
<a name="l00100"></a>00100 <span class="comment">      it is created (instead it is opened in the openRead() method)</span>
<a name="l00101"></a>00101 <span class="comment">      it is not safe to use tempnam-like functions. So we provide our</span>
<a name="l00102"></a>00102 <span class="comment">      own mechanisms to solve filename conflicts.</span>
<a name="l00103"></a>00103 <span class="comment">    */</span>
<a name="l00104"></a>00104     <a class="code" href="classmcs_1_1Pipe.html#00aef3835a63edf24433d90778064dc9" title="To protect the filecount variable.">synchro</a>.<a class="code" href="classmcs_1_1Synchro.html#cb252a6eff363f3ac5f3bff91dc59e35" title="Enter, or try to enter a critical section.">enter</a>();
<a name="l00105"></a>00105     sprintf(filename, <span class="stringliteral">"/tmp/mcspipe%04d"</span>, <a class="code" href="classmcs_1_1Pipe.html#44dad156d8bdb7c8ae7b158515232bf8" title="Used to generate a unique filename.">filecount</a>);
<a name="l00106"></a>00106     <a class="code" href="classmcs_1_1Pipe.html#44dad156d8bdb7c8ae7b158515232bf8" title="Used to generate a unique filename.">filecount</a>++;
<a name="l00107"></a>00107     <a class="code" href="classmcs_1_1Pipe.html#44dad156d8bdb7c8ae7b158515232bf8" title="Used to generate a unique filename.">filecount</a> = <a class="code" href="classmcs_1_1Pipe.html#44dad156d8bdb7c8ae7b158515232bf8" title="Used to generate a unique filename.">filecount</a> % 10000;
<a name="l00108"></a>00108     <a class="code" href="classmcs_1_1Pipe.html#00aef3835a63edf24433d90778064dc9" title="To protect the filecount variable.">synchro</a>.<a class="code" href="classmcs_1_1Synchro.html#8c726a3d1036b22f2273c26d94d99baf" title="Leave a critical section.">leave</a>();
<a name="l00109"></a>00109 
<a name="l00110"></a>00110     <span class="keywordflow">if</span> (mkfifo(filename, S_IREAD | S_IWRITE) == 0)
<a name="l00111"></a>00111       <span class="keywordflow">break</span>;
<a name="l00112"></a>00112 
<a name="l00113"></a>00113     <a class="code" href="namespacemcs.html#f1a42eb6bb713bfa98ac131c657c028e" title="A millisecond resolution sleep function.">sleep_ms</a>(20);
<a name="l00114"></a>00114   } <span class="keywordflow">while</span> (1);
<a name="l00115"></a>00115 
<a name="l00116"></a>00116   <a class="code" href="classmcs_1_1Pipe.html#1ebe6d72d5c141fb3da0735f9ac74bca" title="Name of the FIFO file.">pipefn</a> = filename;
<a name="l00117"></a>00117   <a class="code" href="classmcs_1_1Pipe.html#95eb49fd6a565550a564ec3434e95e66" title="Tell if a pipe has been created.">flcreated</a> = <span class="keyword">true</span>;
<a name="l00118"></a>00118   <a class="code" href="classmcs_1_1Pipe.html#d3e7f4e7d08fd02cc37ad6d23d184440" title="If it is a named pipe (a FIFO file) or not.">named</a> = <span class="keyword">true</span>;
<a name="l00119"></a>00119 
<a name="l00120"></a>00120   <span class="keywordflow">return</span> <a class="code" href="classmcs_1_1Pipe.html#1ebe6d72d5c141fb3da0735f9ac74bca" title="Name of the FIFO file.">pipefn</a>;
<a name="l00121"></a>00121 }
<a name="l00122"></a>00122 
<a name="l00123"></a>00123 
<a name="l00124"></a>00124 
<a name="l00125"></a>00125 
<a name="l00126"></a>00126 
<a name="l00127"></a>00127 
<a name="l00128"></a><a class="code" href="classmcs_1_1Pipe.html#0a45ccba93b0ffb0a00030b67585e173">00128</a> <span class="keywordtype">int</span> <a class="code" href="classmcs_1_1Pipe.html#0a45ccba93b0ffb0a00030b67585e173" title="Return the file descriptor for the consumer side of the pipe.">Pipe::openRead</a>()
<a name="l00129"></a>00129 {
<a name="l00130"></a>00130   <span class="keywordflow">if</span> (! <a class="code" href="classmcs_1_1Pipe.html#95eb49fd6a565550a564ec3434e95e66" title="Tell if a pipe has been created.">flcreated</a>)
<a name="l00131"></a>00131     <span class="keywordflow">throw</span> <a class="code" href="mcs_8hh.html#641a1a9e13c7a3ed2861f2572af8a3f4" title="Facility to easily pass all necessary parameter to an Event constructor.">MCS_ERROR</a>(MSG_PIPE_NOT_CREATED);
<a name="l00132"></a>00132 
<a name="l00133"></a>00133   <span class="keywordflow">if</span> (! <a class="code" href="classmcs_1_1Pipe.html#41ff113cff7c9729cdcea8a32d5a78ea" title="Pipe file descriptors (0 read side, 1 write side).">pipefd</a>[0]) {
<a name="l00134"></a>00134       <span class="keywordflow">if</span> (<a class="code" href="classmcs_1_1Pipe.html#d3e7f4e7d08fd02cc37ad6d23d184440" title="If it is a named pipe (a FIFO file) or not.">named</a>) {
<a name="l00135"></a>00135       <a class="code" href="classmcs_1_1Pipe.html#41ff113cff7c9729cdcea8a32d5a78ea" title="Pipe file descriptors (0 read side, 1 write side).">pipefd</a>[0] = open(<a class="code" href="classmcs_1_1Pipe.html#1ebe6d72d5c141fb3da0735f9ac74bca" title="Name of the FIFO file.">pipefn</a>.c_str(), O_RDONLY);
<a name="l00136"></a>00136       unlink(<a class="code" href="classmcs_1_1Pipe.html#1ebe6d72d5c141fb3da0735f9ac74bca" title="Name of the FIFO file.">pipefn</a>.c_str()); <span class="comment">//Remove the FIFO, it is no longer needed</span>
<a name="l00137"></a>00137       <span class="keywordflow">if</span> (<a class="code" href="classmcs_1_1Pipe.html#41ff113cff7c9729cdcea8a32d5a78ea" title="Pipe file descriptors (0 read side, 1 write side).">pipefd</a>[0] == -1) <span class="keywordflow">throw</span> <a class="code" href="mcs_8hh.html#641a1a9e13c7a3ed2861f2572af8a3f4" title="Facility to easily pass all necessary parameter to an Event constructor.">MCS_ERROR</a>(MSG_CANT_OPEN_FILE, <a class="code" href="classmcs_1_1Pipe.html#1ebe6d72d5c141fb3da0735f9ac74bca" title="Name of the FIFO file.">pipefn</a>.c_str());
<a name="l00138"></a>00138       }
<a name="l00139"></a>00139 
<a name="l00140"></a>00140       <span class="comment">//Ensure the other side hand of the pipe has been opened</span>
<a name="l00141"></a>00141       <span class="keywordflow">while</span> (<a class="code" href="namespacemcs.html#19a005a5a2a2d8a7d497ee0058490391">Select</a>(<a class="code" href="classmcs_1_1Pipe.html#41ff113cff7c9729cdcea8a32d5a78ea" title="Pipe file descriptors (0 read side, 1 write side).">pipefd</a>[0], 0, 100, <a class="code" href="mcs_8hh.html#fe435cd4801653ede4f89d6e83fcae62">MCS_SELECT_READ</a>) != 1) ;
<a name="l00142"></a>00142   }
<a name="l00143"></a>00143 
<a name="l00144"></a>00144   <span class="keywordflow">return</span> <a class="code" href="classmcs_1_1Pipe.html#41ff113cff7c9729cdcea8a32d5a78ea" title="Pipe file descriptors (0 read side, 1 write side).">pipefd</a>[0];
<a name="l00145"></a>00145 }
<a name="l00146"></a>00146 
<a name="l00147"></a>00147 
<a name="l00148"></a><a class="code" href="classmcs_1_1Pipe.html#40cff8a75d39d12436e7defd1b71695c">00148</a> <span class="keywordtype">int</span> <a class="code" href="classmcs_1_1Pipe.html#40cff8a75d39d12436e7defd1b71695c" title="Return the file descriptor for the producer side of the pipe.">Pipe::openWrite</a>()
<a name="l00149"></a>00149 {
<a name="l00150"></a>00150   <span class="keywordflow">if</span> (! <a class="code" href="classmcs_1_1Pipe.html#95eb49fd6a565550a564ec3434e95e66" title="Tell if a pipe has been created.">flcreated</a>)
<a name="l00151"></a>00151     <span class="keywordflow">throw</span> <a class="code" href="mcs_8hh.html#641a1a9e13c7a3ed2861f2572af8a3f4" title="Facility to easily pass all necessary parameter to an Event constructor.">MCS_ERROR</a>(MSG_PIPE_NOT_CREATED);
<a name="l00152"></a>00152 
<a name="l00153"></a>00153   <span class="keywordflow">if</span> (! <a class="code" href="classmcs_1_1Pipe.html#41ff113cff7c9729cdcea8a32d5a78ea" title="Pipe file descriptors (0 read side, 1 write side).">pipefd</a>[1]) {
<a name="l00154"></a>00154       <span class="keywordflow">if</span> (<a class="code" href="classmcs_1_1Pipe.html#d3e7f4e7d08fd02cc37ad6d23d184440" title="If it is a named pipe (a FIFO file) or not.">named</a>) {
<a name="l00155"></a>00155       <a class="code" href="classmcs_1_1Pipe.html#41ff113cff7c9729cdcea8a32d5a78ea" title="Pipe file descriptors (0 read side, 1 write side).">pipefd</a>[1] = open(<a class="code" href="classmcs_1_1Pipe.html#1ebe6d72d5c141fb3da0735f9ac74bca" title="Name of the FIFO file.">pipefn</a>.c_str(), O_WRONLY);
<a name="l00156"></a>00156       unlink(<a class="code" href="classmcs_1_1Pipe.html#1ebe6d72d5c141fb3da0735f9ac74bca" title="Name of the FIFO file.">pipefn</a>.c_str()); <span class="comment">//Remove the FIFO, it is no longer needed</span>
<a name="l00157"></a>00157       <span class="keywordflow">if</span> (<a class="code" href="classmcs_1_1Pipe.html#41ff113cff7c9729cdcea8a32d5a78ea" title="Pipe file descriptors (0 read side, 1 write side).">pipefd</a>[1] == -1) <span class="keywordflow">throw</span> <a class="code" href="mcs_8hh.html#641a1a9e13c7a3ed2861f2572af8a3f4" title="Facility to easily pass all necessary parameter to an Event constructor.">MCS_ERROR</a>(MSG_CANT_OPEN_FILE, <a class="code" href="classmcs_1_1Pipe.html#1ebe6d72d5c141fb3da0735f9ac74bca" title="Name of the FIFO file.">pipefn</a>.c_str());
<a name="l00158"></a>00158       }
<a name="l00159"></a>00159 
<a name="l00160"></a>00160       <span class="comment">//Ensure the other side hand of the pipe has been opened</span>
<a name="l00161"></a>00161       <span class="keywordflow">while</span> (<a class="code" href="namespacemcs.html#19a005a5a2a2d8a7d497ee0058490391">Select</a>(<a class="code" href="classmcs_1_1Pipe.html#41ff113cff7c9729cdcea8a32d5a78ea" title="Pipe file descriptors (0 read side, 1 write side).">pipefd</a>[1], 0, 100, <a class="code" href="mcs_8hh.html#9446251222278f804d0f1030f1fb40bb">MCS_SELECT_WRITE</a>) != 1) ;
<a name="l00162"></a>00162   }
<a name="l00163"></a>00163 
<a name="l00164"></a>00164   <span class="keywordflow">return</span> <a class="code" href="classmcs_1_1Pipe.html#41ff113cff7c9729cdcea8a32d5a78ea" title="Pipe file descriptors (0 read side, 1 write side).">pipefd</a>[1];
<a name="l00165"></a>00165 }
<a name="l00166"></a>00166 
<a name="l00167"></a>00167 
<a name="l00168"></a><a class="code" href="classmcs_1_1Pipe.html#bb8f8864d4b97ebd1d5318e94e7a6424">00168</a> <span class="keywordtype">void</span> <a class="code" href="classmcs_1_1Pipe.html#bb8f8864d4b97ebd1d5318e94e7a6424" title="Close the file descriptor associated with the consumer side of the pipe.">Pipe::closeRead</a>()
<a name="l00169"></a>00169 {
<a name="l00170"></a>00170   <span class="keywordflow">if</span> (! <a class="code" href="classmcs_1_1Pipe.html#95eb49fd6a565550a564ec3434e95e66" title="Tell if a pipe has been created.">flcreated</a>) <span class="keywordflow">return</span>;  <span class="comment">//Already closed</span>
<a name="l00171"></a>00171   <span class="keywordflow">if</span> (<a class="code" href="classmcs_1_1Pipe.html#d3e7f4e7d08fd02cc37ad6d23d184440" title="If it is a named pipe (a FIFO file) or not.">named</a>) unlink(<a class="code" href="classmcs_1_1Pipe.html#1ebe6d72d5c141fb3da0735f9ac74bca" title="Name of the FIFO file.">pipefn</a>.c_str()); <span class="comment">//Remove the FIFO</span>
<a name="l00172"></a>00172 
<a name="l00173"></a>00173   <span class="keywordflow">if</span> (<a class="code" href="classmcs_1_1Pipe.html#41ff113cff7c9729cdcea8a32d5a78ea" title="Pipe file descriptors (0 read side, 1 write side).">pipefd</a>[0]) {
<a name="l00174"></a>00174       <span class="comment">//Close read side of the pipe</span>
<a name="l00175"></a>00175       close(<a class="code" href="classmcs_1_1Pipe.html#41ff113cff7c9729cdcea8a32d5a78ea" title="Pipe file descriptors (0 read side, 1 write side).">pipefd</a>[0]);
<a name="l00176"></a>00176       <a class="code" href="classmcs_1_1Pipe.html#41ff113cff7c9729cdcea8a32d5a78ea" title="Pipe file descriptors (0 read side, 1 write side).">pipefd</a>[0] = 0;
<a name="l00177"></a>00177   }
<a name="l00178"></a>00178 
<a name="l00179"></a>00179   <a class="code" href="classmcs_1_1Pipe.html#1ebe6d72d5c141fb3da0735f9ac74bca" title="Name of the FIFO file.">pipefn</a> = <span class="stringliteral">""</span>;
<a name="l00180"></a>00180   <a class="code" href="classmcs_1_1Pipe.html#95eb49fd6a565550a564ec3434e95e66" title="Tell if a pipe has been created.">flcreated</a> = <span class="keyword">false</span>;
<a name="l00181"></a>00181   <a class="code" href="classmcs_1_1Pipe.html#d3e7f4e7d08fd02cc37ad6d23d184440" title="If it is a named pipe (a FIFO file) or not.">named</a> = <span class="keyword">false</span>;
<a name="l00182"></a>00182 }
<a name="l00183"></a>00183 
<a name="l00184"></a><a class="code" href="classmcs_1_1Pipe.html#8bf28a7d70f3370e96d8a5c7fd13f8f0">00184</a> <span class="keywordtype">void</span> <a class="code" href="classmcs_1_1Pipe.html#8bf28a7d70f3370e96d8a5c7fd13f8f0" title="Close the file descriptor associated with the producer side of the pipe.">Pipe::closeWrite</a>()
<a name="l00185"></a>00185 {
<a name="l00186"></a>00186   <span class="keywordflow">if</span> (! <a class="code" href="classmcs_1_1Pipe.html#95eb49fd6a565550a564ec3434e95e66" title="Tell if a pipe has been created.">flcreated</a>) <span class="keywordflow">return</span>;  <span class="comment">//Already closed</span>
<a name="l00187"></a>00187   <span class="keywordflow">if</span> (<a class="code" href="classmcs_1_1Pipe.html#d3e7f4e7d08fd02cc37ad6d23d184440" title="If it is a named pipe (a FIFO file) or not.">named</a>) unlink(<a class="code" href="classmcs_1_1Pipe.html#1ebe6d72d5c141fb3da0735f9ac74bca" title="Name of the FIFO file.">pipefn</a>.c_str()); <span class="comment">//Remove the FIFO</span>
<a name="l00188"></a>00188 
<a name="l00189"></a>00189   <span class="keywordflow">if</span> (<a class="code" href="classmcs_1_1Pipe.html#41ff113cff7c9729cdcea8a32d5a78ea" title="Pipe file descriptors (0 read side, 1 write side).">pipefd</a>[1]) {
<a name="l00190"></a>00190       <span class="comment">//Close write side of the pipe</span>
<a name="l00191"></a>00191       close(<a class="code" href="classmcs_1_1Pipe.html#41ff113cff7c9729cdcea8a32d5a78ea" title="Pipe file descriptors (0 read side, 1 write side).">pipefd</a>[1]);
<a name="l00192"></a>00192       <a class="code" href="classmcs_1_1Pipe.html#41ff113cff7c9729cdcea8a32d5a78ea" title="Pipe file descriptors (0 read side, 1 write side).">pipefd</a>[1] = 0;
<a name="l00193"></a>00193   }
<a name="l00194"></a>00194 }
<a name="l00195"></a>00195 
<a name="l00196"></a>00196 
<a name="l00197"></a>00197 
<a name="l00198"></a>00198 
<a name="l00199"></a>00199 
<a name="l00200"></a>00200 
<a name="l00201"></a>00201 
<a name="l00202"></a>00202 
<a name="l00203"></a>00203 
<a name="l00204"></a>00204 
<a name="l00205"></a>00205 <span class="keywordtype">bool</span> <a class="code" href="classmcs_1_1URLReader.html#2c450749c635d77e0cc682ae67409efd" title="True if curl_global_init has been called (must be called once).">mcs::URLReader::fl_curl_global_init</a> = <span class="keyword">false</span>;
<a name="l00206"></a>00206 
<a name="l00207"></a><a class="code" href="classmcs_1_1URLReader.html#fefcdfc8cfba7ac50b001fb6b1472585">00207</a> <a class="code" href="classmcs_1_1URLReader.html#fefcdfc8cfba7ac50b001fb6b1472585" title="Constructor.">mcs::URLReader::URLReader</a>() : <a class="code" href="classmcs_1_1Pipe.html" title="A high level class to use system pipes.">Pipe</a>()
<a name="l00208"></a>00208 {
<a name="l00209"></a>00209   <span class="keywordflow">if</span> (! <a class="code" href="classmcs_1_1URLReader.html#2c450749c635d77e0cc682ae67409efd" title="True if curl_global_init has been called (must be called once).">fl_curl_global_init</a>) {
<a name="l00210"></a>00210     <a class="code" href="classmcs_1_1URLReader.html#2c450749c635d77e0cc682ae67409efd" title="True if curl_global_init has been called (must be called once).">fl_curl_global_init</a> = <span class="keyword">true</span>;
<a name="l00211"></a>00211     curl_global_init(CURL_GLOBAL_ALL);
<a name="l00212"></a>00212   }
<a name="l00213"></a>00213 
<a name="l00214"></a>00214   <a class="code" href="classmcs_1_1URLReader.html#3b18bd1c7ed5651cde29fd74bfd44c95">thr</a> = NULL;
<a name="l00215"></a>00215 }
<a name="l00216"></a>00216 
<a name="l00217"></a>00217 
<a name="l00218"></a><a class="code" href="classmcs_1_1URLReader.html#b021a2c335d231615ce110e01030e991">00218</a> <a class="code" href="classmcs_1_1URLReader.html#b021a2c335d231615ce110e01030e991" title="Destructor.">mcs::URLReader::~URLReader</a>()
<a name="l00219"></a>00219 { <a class="code" href="classmcs_1_1URLReader.html#baf12623435804bfe109ee2447648572" title="Terminates a file retrieval.">Close</a>(); }
<a name="l00220"></a>00220 
<a name="l00221"></a>00221 
<a name="l00222"></a><a class="code" href="classmcs_1_1URLReader.html#3d3b4672963892f3c85fb25aff9dad02">00222</a> <span class="keywordtype">string</span> <a class="code" href="classmcs_1_1URLReader.html#3d3b4672963892f3c85fb25aff9dad02">mcs::URLReader::url</a>()
<a name="l00223"></a>00223 { <span class="keywordflow">return</span> <a class="code" href="classmcs_1_1URLReader.html#7faa3d19b6b05a263ae206346ec2f8d5" title="URL requested.">lurl</a>; }
<a name="l00224"></a>00224 
<a name="l00225"></a><a class="code" href="classmcs_1_1URLReader.html#98d90e9e0ab8a3a5c88eab090789b788">00225</a> <span class="keywordtype">bool</span> <a class="code" href="classmcs_1_1URLReader.html#98d90e9e0ab8a3a5c88eab090789b788">mcs::URLReader::chkLocal</a>(<span class="keywordtype">string</span>&amp; <a class="code" href="classmcs_1_1URLReader.html#3d3b4672963892f3c85fb25aff9dad02">url</a>)
<a name="l00226"></a>00226 {
<a name="l00227"></a>00227   <span class="keywordtype">bool</span> <a class="code" href="classmcs_1_1URLReader.html#4a28242301dbba8ed66bff08d7f71888" title="If the URL refer to a resource on local filesystem.">local</a> = (bool) (
<a name="l00228"></a>00228                (url.find(<span class="stringliteral">"://"</span>) == string::npos)   ||
<a name="l00229"></a>00229                (url.find(<span class="stringliteral">"file://"</span>) == 0)
<a name="l00230"></a>00230                );
<a name="l00231"></a>00231 
<a name="l00232"></a>00232   <span class="keywordflow">if</span> (local) url = <a class="code" href="namespacemcs.html#f197b908e8ff0efbdfff002be78f1ede" title="Perform substitutions on a string.">subst</a>(url, <span class="stringliteral">"file://"</span>, <span class="stringliteral">""</span>, <a class="code" href="mcs_8hh.html#2ff79412a3c9cec66c95e048d985f604" title="To be used with subst(), substitute only if &amp;quot;what&amp;quot; is at the beginning...">MCS_SUBST_LEADING</a>);
<a name="l00233"></a>00233   <span class="keywordflow">return</span> local;
<a name="l00234"></a>00234 }
<a name="l00235"></a>00235 
<a name="l00236"></a>00236 
<a name="l00237"></a><a class="code" href="classmcs_1_1URLReader.html#1446986f340c93fbe17fea26cebb5f85">00237</a> <span class="keywordtype">int</span> <a class="code" href="classmcs_1_1URLReader.html#1446986f340c93fbe17fea26cebb5f85" title="Obtain a file descriptor to read the file passed as parameter.">mcs::URLReader::OpenAsFD</a>(<span class="keywordtype">string</span> <a class="code" href="classmcs_1_1URLReader.html#3d3b4672963892f3c85fb25aff9dad02">url</a>)
<a name="l00238"></a>00238 {
<a name="l00239"></a>00239   <a class="code" href="classmcs_1_1URLReader.html#4a28242301dbba8ed66bff08d7f71888" title="If the URL refer to a resource on local filesystem.">local</a> = <a class="code" href="classmcs_1_1URLReader.html#98d90e9e0ab8a3a5c88eab090789b788">chkLocal</a>(url);
<a name="l00240"></a>00240   this-&gt;<a class="code" href="classmcs_1_1URLReader.html#7faa3d19b6b05a263ae206346ec2f8d5" title="URL requested.">lurl</a> = url;
<a name="l00241"></a>00241 
<a name="l00242"></a>00242   <a class="code" href="classmcs_1_1Pipe.html#3ebae63d960d5b772e287ab53e268b19" title="Create an unnamed pipe, both threads will read/write using file descriptors.">create</a>();
<a name="l00243"></a>00243 
<a name="l00244"></a>00244   <a class="code" href="classmcs_1_1URLReader.html#3b18bd1c7ed5651cde29fd74bfd44c95">thr</a> = <span class="keyword">new</span> <a class="code" href="classmcs_1_1ThreadFunc.html">ThreadFunc</a>(<a class="code" href="classmcs_1_1URLReader.html#014c9aa6f06b8c570500b2401cd0e3c3">thread_run</a>, <span class="keyword">this</span>);
<a name="l00245"></a>00245   <a class="code" href="classmcs_1_1URLReader.html#3b18bd1c7ed5651cde29fd74bfd44c95">thr</a>-&gt;<a class="code" href="classmcs_1_1Thread.html#a447c6d9b640f92e74a7a3eb6e4b960e" title="Start a new thread in the detached state.">startDetached</a>();
<a name="l00246"></a>00246   <span class="keywordflow">return</span> <a class="code" href="classmcs_1_1Pipe.html#0a45ccba93b0ffb0a00030b67585e173" title="Return the file descriptor for the consumer side of the pipe.">openRead</a>();
<a name="l00247"></a>00247 }
<a name="l00248"></a>00248 
<a name="l00249"></a>00249 
<a name="l00250"></a><a class="code" href="classmcs_1_1URLReader.html#71c418ccbd42ffb96e6a21a92065df6b">00250</a> <span class="keyword">const</span> <span class="keywordtype">char</span>* <a class="code" href="classmcs_1_1URLReader.html#71c418ccbd42ffb96e6a21a92065df6b" title="Create a FIFO on file system to read from the specified file.">mcs::URLReader::OpenAsFifo</a>(<span class="keywordtype">string</span> <a class="code" href="classmcs_1_1URLReader.html#3d3b4672963892f3c85fb25aff9dad02">url</a>)
<a name="l00251"></a>00251 {
<a name="l00252"></a>00252   <a class="code" href="classmcs_1_1URLReader.html#4a28242301dbba8ed66bff08d7f71888" title="If the URL refer to a resource on local filesystem.">local</a> = <a class="code" href="classmcs_1_1URLReader.html#98d90e9e0ab8a3a5c88eab090789b788">chkLocal</a>(url);
<a name="l00253"></a>00253   this-&gt;<a class="code" href="classmcs_1_1URLReader.html#7faa3d19b6b05a263ae206346ec2f8d5" title="URL requested.">lurl</a> = url;
<a name="l00254"></a>00254 
<a name="l00255"></a>00255   <span class="keywordtype">string</span> fn = <a class="code" href="classmcs_1_1Pipe.html#bd5ece54f657e5583248542d5c11f77b" title="Create a named pipe, that is a FIFO special file and returns the filename.">createNamed</a>();
<a name="l00256"></a>00256 
<a name="l00257"></a>00257   <a class="code" href="classmcs_1_1URLReader.html#3b18bd1c7ed5651cde29fd74bfd44c95">thr</a> = <span class="keyword">new</span> <a class="code" href="classmcs_1_1ThreadFunc.html">ThreadFunc</a>(<a class="code" href="classmcs_1_1URLReader.html#014c9aa6f06b8c570500b2401cd0e3c3">thread_run</a>, <span class="keyword">this</span>);
<a name="l00258"></a>00258   <a class="code" href="classmcs_1_1URLReader.html#3b18bd1c7ed5651cde29fd74bfd44c95">thr</a>-&gt;<a class="code" href="classmcs_1_1Thread.html#a447c6d9b640f92e74a7a3eb6e4b960e" title="Start a new thread in the detached state.">startDetached</a>();
<a name="l00259"></a>00259 
<a name="l00260"></a>00260   <span class="keywordflow">return</span> fn.c_str();
<a name="l00261"></a>00261 }
<a name="l00262"></a>00262 
<a name="l00263"></a>00263 
<a name="l00264"></a>00264 
<a name="l00265"></a><a class="code" href="classmcs_1_1URLReader.html#214f74ca4bda80ff023b9a24fc93fd20">00265</a> <span class="keywordtype">void</span> <a class="code" href="classmcs_1_1URLReader.html#214f74ca4bda80ff023b9a24fc93fd20">mcs::URLReader::Download</a>(<span class="keywordtype">string</span> <a class="code" href="classmcs_1_1URLReader.html#3d3b4672963892f3c85fb25aff9dad02">url</a>, <span class="keywordtype">string</span> fn)
<a name="l00266"></a>00266 {
<a name="l00267"></a>00267   ofstream out(fn.c_str());
<a name="l00268"></a>00268 
<a name="l00269"></a>00269   <span class="keywordflow">if</span> (! out.is_open())
<a name="l00270"></a>00270     <span class="keywordflow">throw</span> <a class="code" href="mcs_8hh.html#641a1a9e13c7a3ed2861f2572af8a3f4" title="Facility to easily pass all necessary parameter to an Event constructor.">MCS_ERROR</a>(MSG_CANT_OPEN_FILE, fn.csz);
<a name="l00271"></a>00271 
<a name="l00272"></a>00272   <span class="keywordtype">int</span> fd = <a class="code" href="classmcs_1_1URLReader.html#1446986f340c93fbe17fea26cebb5f85" title="Obtain a file descriptor to read the file passed as parameter.">OpenAsFD</a>(url);
<a name="l00273"></a>00273   <span class="keywordtype">char</span> buf[1024];
<a name="l00274"></a>00274   <span class="keywordtype">int</span> n;
<a name="l00275"></a>00275 
<a name="l00276"></a>00276   <span class="keywordflow">while</span> ((n = read(fd, buf, 1024)))
<a name="l00277"></a>00277     out.write(buf, n);
<a name="l00278"></a>00278 
<a name="l00279"></a>00279   out.close();
<a name="l00280"></a>00280   <a class="code" href="classmcs_1_1URLReader.html#baf12623435804bfe109ee2447648572" title="Terminates a file retrieval.">Close</a>();
<a name="l00281"></a>00281 }
<a name="l00282"></a>00282 
<a name="l00283"></a>00283 
<a name="l00284"></a>00284 
<a name="l00285"></a><a class="code" href="classmcs_1_1URLReader.html#baf12623435804bfe109ee2447648572">00285</a> <span class="keywordtype">void</span> <a class="code" href="classmcs_1_1URLReader.html#baf12623435804bfe109ee2447648572" title="Terminates a file retrieval.">mcs::URLReader::Close</a>()
<a name="l00286"></a>00286 {
<a name="l00287"></a>00287   <span class="keywordflow">if</span> (<a class="code" href="classmcs_1_1URLReader.html#3b18bd1c7ed5651cde29fd74bfd44c95">thr</a>) {
<a name="l00288"></a>00288     <a class="code" href="classmcs_1_1Pipe.html#bb8f8864d4b97ebd1d5318e94e7a6424" title="Close the file descriptor associated with the consumer side of the pipe.">closeRead</a>();
<a name="l00289"></a>00289     <a class="code" href="classmcs_1_1URLReader.html#7faa3d19b6b05a263ae206346ec2f8d5" title="URL requested.">lurl</a> = <span class="stringliteral">""</span>;
<a name="l00290"></a>00290 
<a name="l00291"></a>00291     <span class="keywordflow">while</span> (<a class="code" href="classmcs_1_1URLReader.html#3b18bd1c7ed5651cde29fd74bfd44c95">thr</a>-&gt;<a class="code" href="classmcs_1_1Thread.html#16548a4ee316fb483168403226fdb340" title="Return the state of the thread.">state</a>() &lt;= <a class="code" href="mcs_8hh.html#587862be6c1d27c7177db0671c1be1a0" title="Thread state: the separate thread is executing the run() method.">MCS_STATE_RUNNING</a>)
<a name="l00292"></a>00292       <a class="code" href="namespacemcs.html#f1a42eb6bb713bfa98ac131c657c028e" title="A millisecond resolution sleep function.">sleep_ms</a>(20);
<a name="l00293"></a>00293 
<a name="l00294"></a>00294     <span class="keywordflow">if</span> (<a class="code" href="classmcs_1_1URLReader.html#3b18bd1c7ed5651cde29fd74bfd44c95">thr</a>-&gt;<a class="code" href="classmcs_1_1Thread.html#6939c43afe1a403a8eb4e11fb6a78f71" title="Return last error message.">error</a>())
<a name="l00295"></a>00295     {
<a name="l00296"></a>00296       <a class="code" href="classmcs_1_1Event.html" title="Hold informations about an event.">Event</a> e = *<a class="code" href="classmcs_1_1URLReader.html#3b18bd1c7ed5651cde29fd74bfd44c95">thr</a>-&gt;<a class="code" href="classmcs_1_1Thread.html#6939c43afe1a403a8eb4e11fb6a78f71" title="Return last error message.">error</a>();
<a name="l00297"></a>00297       <span class="keyword">delete</span> <a class="code" href="classmcs_1_1URLReader.html#3b18bd1c7ed5651cde29fd74bfd44c95">thr</a>;
<a name="l00298"></a>00298       <a class="code" href="classmcs_1_1URLReader.html#3b18bd1c7ed5651cde29fd74bfd44c95">thr</a> = NULL;
<a name="l00299"></a>00299       <span class="keywordflow">throw</span> e;
<a name="l00300"></a>00300     }
<a name="l00301"></a>00301     <span class="keyword">delete</span> <a class="code" href="classmcs_1_1URLReader.html#3b18bd1c7ed5651cde29fd74bfd44c95">thr</a>;
<a name="l00302"></a>00302     <a class="code" href="classmcs_1_1URLReader.html#3b18bd1c7ed5651cde29fd74bfd44c95">thr</a> = NULL;
<a name="l00303"></a>00303   }
<a name="l00304"></a>00304 }
<a name="l00305"></a>00305 
<a name="l00306"></a>00306 
<a name="l00307"></a>00307 
<a name="l00308"></a><a class="code" href="classmcs_1_1URLReader.html#014c9aa6f06b8c570500b2401cd0e3c3">00308</a> <span class="keywordtype">int</span> <a class="code" href="classmcs_1_1URLReader.html#014c9aa6f06b8c570500b2401cd0e3c3">mcs::URLReader::thread_run</a>(<span class="keywordtype">void</span>* p)
<a name="l00309"></a>00309 {
<a name="l00310"></a>00310   <a class="code" href="classmcs_1_1URLReader.html" title="A class that provide a uniform access to file retrieving.">URLReader</a>* This = (<a class="code" href="classmcs_1_1URLReader.html" title="A class that provide a uniform access to file retrieving.">URLReader</a>*) p;
<a name="l00311"></a>00311   This-&gt;<a class="code" href="classmcs_1_1URLReader.html#416a5aa126f1f1f9d5f9a7d5a300a601">thread_fetch</a>();
<a name="l00312"></a>00312   <span class="keywordflow">return</span> 0;
<a name="l00313"></a>00313 }
<a name="l00314"></a>00314 
<a name="l00315"></a>00315 
<a name="l00316"></a><a class="code" href="classmcs_1_1URLReader.html#416a5aa126f1f1f9d5f9a7d5a300a601">00316</a> <span class="keywordtype">void</span> <a class="code" href="classmcs_1_1URLReader.html#416a5aa126f1f1f9d5f9a7d5a300a601">mcs::URLReader::thread_fetch</a>()
<a name="l00317"></a>00317 {
<a name="l00318"></a>00318   <a class="code" href="classmcs_1_1Pipe.html#40cff8a75d39d12436e7defd1b71695c" title="Return the file descriptor for the producer side of the pipe.">openWrite</a>();  <span class="comment">//Open file for writing, it is necessary here otherwise the</span>
<a name="l00319"></a>00319         <span class="comment">//openRead() on the other thread won't return</span>
<a name="l00320"></a>00320 
<a name="l00321"></a>00321   <span class="keywordflow">if</span> (<a class="code" href="classmcs_1_1URLReader.html#4a28242301dbba8ed66bff08d7f71888" title="If the URL refer to a resource on local filesystem.">local</a>) {
<a name="l00322"></a>00322     <span class="keywordtype">int</span> fd = open(<a class="code" href="classmcs_1_1URLReader.html#7faa3d19b6b05a263ae206346ec2f8d5" title="URL requested.">lurl</a>.c_str(), O_RDONLY);
<a name="l00323"></a>00323     <span class="keywordtype">char</span> buf[1024];
<a name="l00324"></a>00324     <span class="keywordtype">int</span> len;
<a name="l00325"></a>00325 
<a name="l00326"></a>00326     <span class="keywordflow">if</span> (fd == -1) {
<a name="l00327"></a>00327       <a class="code" href="classmcs_1_1Pipe.html#8bf28a7d70f3370e96d8a5c7fd13f8f0" title="Close the file descriptor associated with the producer side of the pipe.">closeWrite</a>();
<a name="l00328"></a>00328       <span class="keywordflow">throw</span> <a class="code" href="mcs_8hh.html#641a1a9e13c7a3ed2861f2572af8a3f4" title="Facility to easily pass all necessary parameter to an Event constructor.">MCS_ERROR</a>(MSG_CANT_OPEN_FILE, <a class="code" href="classmcs_1_1URLReader.html#7faa3d19b6b05a263ae206346ec2f8d5" title="URL requested.">lurl</a>.c_str());
<a name="l00329"></a>00329     }
<a name="l00330"></a>00330 
<a name="l00331"></a>00331     <span class="keywordflow">while</span> ((len = read(fd, buf, 1024)))
<a name="l00332"></a>00332       <a class="code" href="classmcs_1_1URLReader.html#e79161dd9fb2e24e5dba9c2708023e42">cb_write</a>(buf, len, 1, <span class="keyword">this</span>);
<a name="l00333"></a>00333 
<a name="l00334"></a>00334     <a class="code" href="classmcs_1_1Pipe.html#8bf28a7d70f3370e96d8a5c7fd13f8f0" title="Close the file descriptor associated with the producer side of the pipe.">closeWrite</a>();
<a name="l00335"></a>00335   }
<a name="l00336"></a>00336   <span class="keywordflow">else</span> {
<a name="l00337"></a>00337     CURLcode res;
<a name="l00338"></a>00338     CURL* curl = curl_easy_init();
<a name="l00339"></a>00339 
<a name="l00340"></a>00340     <span class="keywordflow">if</span> (! curl)
<a name="l00341"></a>00341       <span class="keywordflow">throw</span> <a class="code" href="mcs_8hh.html#641a1a9e13c7a3ed2861f2572af8a3f4" title="Facility to easily pass all necessary parameter to an Event constructor.">MCS_ERROR</a>(MSG_CURL_INIT);
<a name="l00342"></a>00342 
<a name="l00343"></a>00343     res = curl_easy_setopt(curl, CURLOPT_NOSIGNAL, 1);
<a name="l00344"></a>00344     <span class="keywordflow">if</span> (res != CURLE_OK) <span class="keywordflow">goto</span> error;
<a name="l00345"></a>00345 
<a name="l00346"></a>00346     <span class="comment">//Timeout in seconds</span>
<a name="l00347"></a>00347     res = curl_easy_setopt(curl, CURLOPT_CONNECTTIMEOUT, 60);
<a name="l00348"></a>00348     <span class="keywordflow">if</span> (res != CURLE_OK) <span class="keywordflow">goto</span> error;
<a name="l00349"></a>00349 
<a name="l00350"></a>00350     res = curl_easy_setopt(curl, CURLOPT_TIMEOUT, 10);
<a name="l00351"></a>00351     <span class="keywordflow">if</span> (res != CURLE_OK) <span class="keywordflow">goto</span> error;
<a name="l00352"></a>00352 
<a name="l00353"></a>00353     res = curl_easy_setopt(curl, CURLOPT_URL, <a class="code" href="classmcs_1_1URLReader.html#7faa3d19b6b05a263ae206346ec2f8d5" title="URL requested.">lurl</a>.c_str());
<a name="l00354"></a>00354     <span class="keywordflow">if</span> (res != CURLE_OK) <span class="keywordflow">goto</span> error;
<a name="l00355"></a>00355 
<a name="l00356"></a>00356     <span class="comment">//res = curl_easy_setopt(curl, CURLOPT_PROGRESSFUNCTION, cb_progress);</span>
<a name="l00357"></a>00357     <span class="comment">//if (res != CURLE_OK) goto error;</span>
<a name="l00358"></a>00358 
<a name="l00359"></a>00359     res = curl_easy_setopt(curl, CURLOPT_WRITEFUNCTION, <a class="code" href="classmcs_1_1URLReader.html#e79161dd9fb2e24e5dba9c2708023e42">cb_write</a>);
<a name="l00360"></a>00360     <span class="keywordflow">if</span> (res != CURLE_OK) <span class="keywordflow">goto</span> error;
<a name="l00361"></a>00361 
<a name="l00362"></a>00362     res = curl_easy_setopt(curl, CURLOPT_WRITEDATA, <span class="keyword">this</span>);
<a name="l00363"></a>00363     <span class="keywordflow">if</span> (res != CURLE_OK) <span class="keywordflow">goto</span> error;
<a name="l00364"></a>00364 
<a name="l00365"></a>00365     res = curl_easy_setopt(curl, CURLOPT_PRIVATE, <span class="keyword">this</span>);
<a name="l00366"></a>00366     <span class="keywordflow">if</span> (res != CURLE_OK) <span class="keywordflow">goto</span> error;
<a name="l00367"></a>00367 
<a name="l00368"></a>00368     res = curl_easy_perform(curl);
<a name="l00369"></a>00369     <span class="keywordflow">if</span> (res != 0) <span class="keywordflow">goto</span> error;
<a name="l00370"></a>00370 
<a name="l00371"></a>00371     <a class="code" href="classmcs_1_1Pipe.html#8bf28a7d70f3370e96d8a5c7fd13f8f0" title="Close the file descriptor associated with the producer side of the pipe.">closeWrite</a>();
<a name="l00372"></a>00372     <span class="keywordflow">return</span>;
<a name="l00373"></a>00373 
<a name="l00374"></a>00374   error:
<a name="l00375"></a>00375     <a class="code" href="classmcs_1_1Pipe.html#8bf28a7d70f3370e96d8a5c7fd13f8f0" title="Close the file descriptor associated with the producer side of the pipe.">closeWrite</a>();
<a name="l00376"></a>00376     curl_easy_cleanup((CURL*) curl);
<a name="l00377"></a>00377     <span class="keywordflow">throw</span> <a class="code" href="mcs_8hh.html#641a1a9e13c7a3ed2861f2572af8a3f4" title="Facility to easily pass all necessary parameter to an Event constructor.">MCS_ERROR</a>(MSG_CURL_ERROR, curl_easy_strerror(res));
<a name="l00378"></a>00378   }
<a name="l00379"></a>00379 }
<a name="l00380"></a>00380 
<a name="l00381"></a>00381 
<a name="l00382"></a><a class="code" href="classmcs_1_1URLReader.html#e79161dd9fb2e24e5dba9c2708023e42">00382</a> <span class="keywordtype">size_t</span> <a class="code" href="classmcs_1_1URLReader.html#e79161dd9fb2e24e5dba9c2708023e42">mcs::URLReader::cb_write</a>(<span class="keywordtype">void</span> *ptr, <span class="keywordtype">size_t</span> size, <span class="keywordtype">size_t</span> nmemb,
<a name="l00383"></a>00383                 <span class="keywordtype">void</span> *This)
<a name="l00384"></a>00384 {
<a name="l00385"></a>00385   <a class="code" href="classmcs_1_1URLReader.html" title="A class that provide a uniform access to file retrieving.">URLReader</a>* p = (<a class="code" href="classmcs_1_1URLReader.html" title="A class that provide a uniform access to file retrieving.">URLReader</a>*) This;
<a name="l00386"></a>00386 
<a name="l00387"></a>00387   <span class="keywordflow">if</span> (p-&gt;<a class="code" href="classmcs_1_1Pipe.html#82f77c903135c50afe7ec956142d832b" title="Tell if the consumer thread is still reading.">consumerHasGone</a>())  <span class="comment">//The pipe has been closed on the consumer side</span>
<a name="l00388"></a>00388     <span class="keywordflow">return</span> 0;  <span class="comment">//This will abort CURL data fetching</span>
<a name="l00389"></a>00389 
<a name="l00390"></a>00390   <span class="comment">//The Write() method is virtual because some derived class may wants</span>
<a name="l00391"></a>00391   <span class="comment">//to write in a different manner</span>
<a name="l00392"></a>00392   <span class="keywordflow">return</span> p-&gt;<a class="code" href="classmcs_1_1URLReader.html#008dce2b66d66fdc96fd4dac970c5491" title="Writes a chunk of data into the pipe.">Write</a>(ptr, size, nmemb);
<a name="l00393"></a>00393 }
<a name="l00394"></a>00394 
<a name="l00395"></a>00395 
<a name="l00396"></a><a class="code" href="classmcs_1_1URLReader.html#ab33c3d0944480ac0cd9df7f84742ad4">00396</a> <span class="keywordtype">void</span> <a class="code" href="classmcs_1_1URLReader.html#ab33c3d0944480ac0cd9df7f84742ad4">mcs::URLReader::flush</a>()
<a name="l00397"></a>00397 { fsync(<a class="code" href="classmcs_1_1Pipe.html#40cff8a75d39d12436e7defd1b71695c" title="Return the file descriptor for the producer side of the pipe.">openWrite</a>()); }
<a name="l00398"></a>00398 
<a name="l00399"></a>00399 
<a name="l00400"></a>00400 <span class="comment">//In the base class version of the Write() method simply writes on</span>
<a name="l00401"></a>00401 <span class="comment">//output file descriptor.</span>
<a name="l00402"></a><a class="code" href="classmcs_1_1URLReader.html#008dce2b66d66fdc96fd4dac970c5491">00402</a> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="classmcs_1_1URLReader.html#008dce2b66d66fdc96fd4dac970c5491" title="Writes a chunk of data into the pipe.">mcs::URLReader::Write</a>(<span class="keywordtype">void</span> *ptr, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> size,
<a name="l00403"></a>00403                    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> nmemb)
<a name="l00404"></a>00404 {  <span class="keywordflow">return</span> write(<a class="code" href="classmcs_1_1Pipe.html#40cff8a75d39d12436e7defd1b71695c" title="Return the file descriptor for the producer side of the pipe.">openWrite</a>(), ptr, size * nmemb); }
<a name="l00405"></a>00405 
<a name="l00406"></a>00406 
<a name="l00407"></a>00407 
<a name="l00408"></a>00408 
<a name="l00409"></a><a class="code" href="classmcs_1_1URLReader.html#3a2e3a73da7e3977baf0366fc459da50">00409</a> <span class="keywordtype">int</span> <a class="code" href="classmcs_1_1URLReader.html#3a2e3a73da7e3977baf0366fc459da50" title="Read from the resource.">mcs::URLReader::Read</a>(<span class="keywordtype">char</span>* buf, <span class="keywordtype">int</span> maxlen)
<a name="l00410"></a>00410 { <span class="keywordflow">return</span> read(<a class="code" href="classmcs_1_1Pipe.html#0a45ccba93b0ffb0a00030b67585e173" title="Return the file descriptor for the consumer side of the pipe.">openRead</a>(), buf, maxlen); }
<a name="l00411"></a>00411 
<a name="l00412"></a>00412 
<a name="l00413"></a>00413 <span class="comment">//Event* mcs::URLReader::thread_error()</span>
<a name="l00414"></a>00414 <span class="comment">//{</span>
<a name="l00415"></a>00415 <span class="comment">//  if (thr)</span>
<a name="l00416"></a>00416 <span class="comment">//    return thr-&gt;error();</span>
<a name="l00417"></a>00417 <span class="comment">//</span>
<a name="l00418"></a>00418 <span class="comment">//  return NULL;</span>
<a name="l00419"></a>00419 <span class="comment">//}</span>
<a name="l00420"></a>00420 
<a name="l00421"></a>00421 
<a name="l00422"></a>00422 <span class="comment">//int mcs::URLReader::cb_progress(void *clientp,</span>
<a name="l00423"></a>00423 <span class="comment">//              double dltotal, double dlnow,</span>
<a name="l00424"></a>00424 <span class="comment">//              double ultotal, double ulnow)</span>
<a name="l00425"></a>00425 <span class="comment">//{</span>
<a name="l00426"></a>00426 <span class="comment">//  cout &lt;&lt; "Download statistics: " &lt;&lt; dlnow &lt;&lt; " : " &lt;&lt; dltotal &lt;&lt; endl;</span>
<a name="l00427"></a>00427 <span class="comment">//  return 0; //Continue reading</span>
<a name="l00428"></a>00428 <span class="comment">//}</span>
<a name="l00429"></a>00429 
<a name="l00430"></a>00430 
<a name="l00431"></a>00431 
<a name="l00432"></a>00432 
<a name="l00433"></a>00433 <span class="preprocessor">#if ENABLE_CFITSIO</span>
<a name="l00434"></a><a class="code" href="namespacemcs.html#719af6f417d5940505a4131e071bf143">00434</a> <span class="preprocessor"></span><span class="keywordtype">string</span> <a class="code" href="namespacemcs.html#719af6f417d5940505a4131e071bf143" title="Return a description of a FITS error.">mcs::fitsError</a>(<span class="keywordtype">int</span> status) {
<a name="l00435"></a>00435   <span class="keywordtype">char</span> buf[31];
<a name="l00436"></a>00436   fits_get_errstatus(status, buf);
<a name="l00437"></a>00437   <span class="keywordflow">return</span> string(buf);
<a name="l00438"></a>00438 }
<a name="l00439"></a>00439 
<a name="l00440"></a>00440 
<a name="l00441"></a><a class="code" href="classmcs_1_1FITSReader.html#979703bcbb4c84432ff0b74641d8bfad">00441</a> <a class="code" href="classmcs_1_1FITSReader.html#979703bcbb4c84432ff0b74641d8bfad">FITSReader::FITSReader</a>() : <a class="code" href="classmcs_1_1RecordSet.html" title="The base class that implement the data abstraction layer.">RecordSet</a>()
<a name="l00442"></a>00442 { <a class="code" href="classmcs_1_1FITSReader.html#fe7dc3c64af4d5578b906a0a6922f513">fptr</a> = NULL; }
<a name="l00443"></a>00443 
<a name="l00444"></a>00444 
<a name="l00445"></a><a class="code" href="classmcs_1_1FITSReader.html#9a73db29ac0e1f4579cd5ad371b583cd">00445</a> <a class="code" href="classmcs_1_1FITSReader.html#9a73db29ac0e1f4579cd5ad371b583cd">FITSReader::~FITSReader</a>()
<a name="l00446"></a>00446 {}
<a name="l00447"></a>00447 
<a name="l00448"></a>00448 
<a name="l00449"></a>00449 <span class="preprocessor">#define FITSKEYLEN 70</span>
<a name="l00450"></a>00450 <span class="preprocessor"></span><span class="preprocessor">#define CHECK_FITS_ERROR if (status) throw MCS_ERROR(MSG_FITS_ERROR, fitsError(status).c_str())</span>
<a name="l00451"></a>00451 <span class="preprocessor"></span>
<a name="l00452"></a>00452 
<a name="l00453"></a><a class="code" href="classmcs_1_1FITSReader.html#0077c45dbf57ec7da232f23b679429c1">00453</a> <span class="keywordtype">int</span> <a class="code" href="classmcs_1_1FITSReader.html#0077c45dbf57ec7da232f23b679429c1">FITSReader::HDUCount</a>()
<a name="l00454"></a>00454 {
<a name="l00455"></a>00455   <span class="keywordtype">int</span> status = 0;
<a name="l00456"></a>00456   fitsfile *<a class="code" href="classmcs_1_1FITSReader.html#fe7dc3c64af4d5578b906a0a6922f513">fptr</a> = (fitsfile*) this-&gt;fptr;
<a name="l00457"></a>00457 
<a name="l00458"></a>00458   fits_get_num_hdus(fptr, &amp;<a class="code" href="classmcs_1_1FITSReader.html#a449a4fb6ba0da4621c60070c6804c14">nhdu</a>, &amp;status);
<a name="l00459"></a>00459 
<a name="l00460"></a>00460   <span class="keywordflow">return</span> <a class="code" href="classmcs_1_1FITSReader.html#a449a4fb6ba0da4621c60070c6804c14">nhdu</a>;
<a name="l00461"></a>00461 }
<a name="l00462"></a>00462 
<a name="l00463"></a>00463 
<a name="l00464"></a><a class="code" href="classmcs_1_1FITSReader.html#2ffc7941947ae22c0d23c62886440567">00464</a> <span class="keywordtype">int</span> <a class="code" href="classmcs_1_1FITSReader.html#2ffc7941947ae22c0d23c62886440567">FITSReader::currentHDU</a>()
<a name="l00465"></a>00465 {
<a name="l00466"></a>00466   <span class="keywordtype">int</span> i;
<a name="l00467"></a>00467   fitsfile *<a class="code" href="classmcs_1_1FITSReader.html#fe7dc3c64af4d5578b906a0a6922f513">fptr</a> = (fitsfile*) this-&gt;fptr;
<a name="l00468"></a>00468   fits_get_hdu_num(fptr, &amp;i);
<a name="l00469"></a>00469 
<a name="l00470"></a>00470   <span class="keywordflow">return</span> i;
<a name="l00471"></a>00471 }
<a name="l00472"></a>00472 
<a name="l00473"></a><a class="code" href="classmcs_1_1FITSReader.html#f2d8d9db972949605d3115df48f611e2">00473</a> <span class="keywordtype">void</span> <a class="code" href="classmcs_1_1FITSReader.html#391803d7ba4764431babba17a220f089">FITSReader::selectHDU</a>(<span class="keywordtype">string</span> name, <span class="keywordtype">int</span> extver)
<a name="l00474"></a>00474 {
<a name="l00475"></a>00475   <span class="keywordtype">int</span> status, i;
<a name="l00476"></a>00476   fitsfile *<a class="code" href="classmcs_1_1FITSReader.html#fe7dc3c64af4d5578b906a0a6922f513">fptr</a> = (fitsfile*) this-&gt;fptr;
<a name="l00477"></a>00477 
<a name="l00478"></a>00478   status = 0;
<a name="l00479"></a>00479   fits_movnam_hdu(fptr, ANY_HDU, (<span class="keywordtype">char</span>*) name.c_str(), extver, &amp;status);
<a name="l00480"></a>00480   CHECK_FITS_ERROR;
<a name="l00481"></a>00481 
<a name="l00482"></a>00482   fits_get_hdu_num(fptr, &amp;i);
<a name="l00483"></a>00483   <a class="code" href="classmcs_1_1FITSReader.html#391803d7ba4764431babba17a220f089">selectHDU</a>(i);
<a name="l00484"></a>00484 }
<a name="l00485"></a>00485 
<a name="l00486"></a>00486 
<a name="l00487"></a><a class="code" href="classmcs_1_1FITSReader.html#d5df3beff3866917127687a4989e1c05">00487</a> <span class="keywordtype">bool</span> <a class="code" href="classmcs_1_1FITSReader.html#d5df3beff3866917127687a4989e1c05">FITSReader::selectNextHDU</a>()
<a name="l00488"></a>00488 {
<a name="l00489"></a>00489   <span class="keywordtype">int</span> status = 0;
<a name="l00490"></a>00490   <span class="keywordtype">int</span> exttype = ANY_HDU;
<a name="l00491"></a>00491 
<a name="l00492"></a>00492   fitsfile *<a class="code" href="classmcs_1_1FITSReader.html#fe7dc3c64af4d5578b906a0a6922f513">fptr</a> = (fitsfile*) this-&gt;fptr;
<a name="l00493"></a>00493 
<a name="l00494"></a>00494   fits_movrel_hdu(fptr, 1, &amp;exttype, &amp;status);
<a name="l00495"></a>00495   <span class="keywordflow">if</span> (status == END_OF_FILE)
<a name="l00496"></a>00496     <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00497"></a>00497 
<a name="l00498"></a>00498   CHECK_FITS_ERROR;
<a name="l00499"></a>00499   <a class="code" href="classmcs_1_1FITSReader.html#391803d7ba4764431babba17a220f089">selectHDU</a>(<a class="code" href="classmcs_1_1FITSReader.html#2ffc7941947ae22c0d23c62886440567">currentHDU</a>());
<a name="l00500"></a>00500 
<a name="l00501"></a>00501   <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00502"></a>00502 }
<a name="l00503"></a>00503 
<a name="l00504"></a>00504 
<a name="l00505"></a><a class="code" href="classmcs_1_1FITSReader.html#391803d7ba4764431babba17a220f089">00505</a> <span class="keywordtype">void</span> <a class="code" href="classmcs_1_1FITSReader.html#391803d7ba4764431babba17a220f089">FITSReader::selectHDU</a>(<span class="keywordtype">int</span> hdunum)
<a name="l00506"></a>00506 {
<a name="l00507"></a>00507   <span class="keywordtype">int</span> status;
<a name="l00508"></a>00508   <span class="keywordtype">long</span> <span class="keywordtype">int</span> repeat, width;
<a name="l00509"></a>00509   <span class="keywordtype">int</span> i, j;
<a name="l00510"></a>00510   <span class="keywordtype">int</span> fits_type;
<a name="l00511"></a>00511   <a class="code" href="namespacemcs.html#cc0a00c9c7f1f52d335b6e64bbc5fca6" title="Enumeration of base type for Data.">Types</a> type;
<a name="l00512"></a>00512   <span class="keywordtype">bool</span> flunsign;
<a name="l00513"></a>00513   <span class="keywordtype">string</span> s;
<a name="l00514"></a>00514   <span class="keywordtype">char</span> buf[FITSKEYLEN];
<a name="l00515"></a>00515   <span class="keywordtype">char</span> reqColName[5];
<a name="l00516"></a>00516   <span class="keywordtype">char</span> head_name[80];
<a name="l00517"></a>00517   <span class="keywordtype">char</span> head_val[80];
<a name="l00518"></a>00518   <span class="keywordtype">char</span> head_comment[80];
<a name="l00519"></a>00519   <a class="code" href="classmcs_1_1Record.html" title="A dynamic array of Data objects.">Record</a> meta;
<a name="l00520"></a>00520   <span class="keywordtype">int</span> nkeys;
<a name="l00521"></a>00521   <span class="keywordtype">int</span> hdutype;
<a name="l00522"></a>00522 
<a name="l00523"></a>00523   fitsfile *<a class="code" href="classmcs_1_1FITSReader.html#fe7dc3c64af4d5578b906a0a6922f513">fptr</a> = (fitsfile*) this-&gt;fptr;
<a name="l00524"></a>00524   fits_get_num_hdus(fptr, &amp;<a class="code" href="classmcs_1_1FITSReader.html#a449a4fb6ba0da4621c60070c6804c14">nhdu</a>, &amp;status);
<a name="l00525"></a>00525 
<a name="l00526"></a>00526   <span class="keywordflow">if</span> ((hdunum &lt;= 0)   ||   (hdunum &gt; <a class="code" href="classmcs_1_1FITSReader.html#a449a4fb6ba0da4621c60070c6804c14">nhdu</a>))
<a name="l00527"></a>00527       <span class="keywordflow">throw</span>; <span class="comment">//ERROR</span>
<a name="l00528"></a>00528 
<a name="l00529"></a>00529   status = 0;
<a name="l00530"></a>00530   hdutype = ANY_HDU;
<a name="l00531"></a>00531   fits_movabs_hdu(fptr, hdunum, &amp;hdutype, &amp;status);
<a name="l00532"></a>00532   CHECK_FITS_ERROR;
<a name="l00533"></a>00533 
<a name="l00534"></a>00534   fits_get_hdrspace(fptr, &amp;nkeys, NULL, &amp;status);
<a name="l00535"></a>00535   CHECK_FITS_ERROR;
<a name="l00536"></a>00536 
<a name="l00537"></a>00537   <a class="code" href="classmcs_1_1FITSReader.html#43a16cef81dc34e9c4d4637617093686">header</a>.<a class="code" href="classmcs_1_1Record.html#d90a2d8904eae70fdd46d5648e556a22">clear</a>();
<a name="l00538"></a>00538   <a class="code" href="classmcs_1_1FITSReader.html#38e216bcdbe6cf84d44b3522d8eaac3e">header_comments</a>.<a class="code" href="classmcs_1_1Record.html#d90a2d8904eae70fdd46d5648e556a22">clear</a>();
<a name="l00539"></a>00539 
<a name="l00540"></a>00540   <span class="keywordflow">for</span> (i=1; i&lt;=nkeys; i++) {
<a name="l00541"></a>00541     fits_read_keyn(fptr, i, head_name, head_val, head_comment, &amp;status);
<a name="l00542"></a>00542     CHECK_FITS_ERROR;
<a name="l00543"></a>00543 
<a name="l00544"></a>00544     <a class="code" href="classmcs_1_1Data.html" title="A general purpose data type.">Data</a>* d = <span class="keyword">new</span> <a class="code" href="classmcs_1_1Data.html" title="A general purpose data type.">Data</a>(<span class="keywordtype">string</span>(head_val));
<a name="l00545"></a>00545     d-&gt;<a class="code" href="classmcs_1_1Data.html#5952481491c13e04c0edeaf64ebf001b">setName</a>(<span class="keywordtype">string</span>(head_name));
<a name="l00546"></a>00546     <a class="code" href="classmcs_1_1FITSReader.html#43a16cef81dc34e9c4d4637617093686">header</a>.<a class="code" href="classmcs_1_1Record.html#8c8b3eaab0df87b6876bcd542cd80ad8" title="Wrapper around Dynamic_Array.push.">addField</a>(d);
<a name="l00547"></a>00547 
<a name="l00548"></a>00548     d = <span class="keyword">new</span> <a class="code" href="classmcs_1_1Data.html" title="A general purpose data type.">Data</a>(<span class="keywordtype">string</span>(head_comment));
<a name="l00549"></a>00549     d-&gt;<a class="code" href="classmcs_1_1Data.html#5952481491c13e04c0edeaf64ebf001b">setName</a>(<span class="keywordtype">string</span>(head_name));
<a name="l00550"></a>00550     <a class="code" href="classmcs_1_1FITSReader.html#38e216bcdbe6cf84d44b3522d8eaac3e">header_comments</a>.<a class="code" href="classmcs_1_1Record.html#8c8b3eaab0df87b6876bcd542cd80ad8" title="Wrapper around Dynamic_Array.push.">addField</a>(d);
<a name="l00551"></a>00551   }
<a name="l00552"></a>00552 
<a name="l00553"></a>00553   fits_get_hdu_type(fptr, &amp;hdutype, &amp;status);
<a name="l00554"></a>00554   CHECK_FITS_ERROR;
<a name="l00555"></a>00555 
<a name="l00556"></a>00556   <span class="keywordflow">if</span> ((hdutype == BINARY_TBL)   ||
<a name="l00557"></a>00557       (hdutype == ASCII_TBL)       ) {
<a name="l00558"></a>00558     <span class="comment">//Number of records</span>
<a name="l00559"></a>00559     fits_get_num_rows(fptr, &amp;<a class="code" href="classmcs_1_1FITSReader.html#e1f86d5c8b0eb0e0d2826a19713ca4f7">nrows</a>, &amp;status);
<a name="l00560"></a>00560     CHECK_FITS_ERROR;
<a name="l00561"></a>00561 
<a name="l00562"></a>00562     <span class="comment">//Number of fields</span>
<a name="l00563"></a>00563     fits_get_num_cols(fptr, &amp;<a class="code" href="classmcs_1_1FITSReader.html#8e545d6972e59479b8e03a3d64f465d3">ncols</a>, &amp;status);
<a name="l00564"></a>00564     CHECK_FITS_ERROR;
<a name="l00565"></a>00565 
<a name="l00566"></a>00566     <span class="keywordflow">for</span> (i=0; i&lt; <a class="code" href="classmcs_1_1FITSReader.html#8e545d6972e59479b8e03a3d64f465d3">ncols</a>; i++) {
<a name="l00567"></a>00567       sprintf(reqColName, <span class="stringliteral">"%d"</span>, i+1);
<a name="l00568"></a>00568       fits_get_colname(fptr, CASEINSEN, reqColName, buf, &amp;j, &amp;status);
<a name="l00569"></a>00569       fits_get_coltype(fptr, j, &amp;fits_type, &amp;repeat, &amp;width, &amp;status);
<a name="l00570"></a>00570       CHECK_FITS_ERROR;
<a name="l00571"></a>00571 
<a name="l00572"></a>00572       <span class="keywordflow">if</span> (! <a class="code" href="namespacemcs.html#ec15de26aab931e83149cf371e4e3c5c" title="Convert a FITSIO type into a MCS type.">FITS2Types</a>(fits_type, type, flunsign))
<a name="l00573"></a>00573     <span class="keywordflow">throw</span> <a class="code" href="mcs_8hh.html#641a1a9e13c7a3ed2861f2572af8a3f4" title="Facility to easily pass all necessary parameter to an Event constructor.">MCS_ERROR</a>(MSG_TYPE_NOT_HANDLED, i, fits_type);
<a name="l00574"></a>00574 
<a name="l00575"></a>00575       <span class="keywordflow">if</span> (! <a class="code" href="namespacemcs.html#1d2fda0d77c15f3b7d150807ca78148e" title="Tell if &amp;quot;type&amp;quot; is a variable length type.">VarLenType</a>(type))
<a name="l00576"></a>00576     width = 0;
<a name="l00577"></a>00577 
<a name="l00578"></a>00578       <a class="code" href="classmcs_1_1Data.html" title="A general purpose data type.">Data</a>* d = <span class="keyword">new</span> <a class="code" href="classmcs_1_1Data.html" title="A general purpose data type.">Data</a>(NULL, type, buf, width, flunsign);
<a name="l00579"></a>00579       meta.<a class="code" href="classmcs_1_1Record.html#8c8b3eaab0df87b6876bcd542cd80ad8" title="Wrapper around Dynamic_Array.push.">addField</a>(d);
<a name="l00580"></a>00580     }
<a name="l00581"></a>00581 
<a name="l00582"></a>00582     i = <a class="code" href="mcs_8hh.html#6726a293d6d91ce8ea49f5fa4f7116bc" title="Flag for RecordSet::init().">MCS_RS_USEMETAREC</a> | <a class="code" href="mcs_8hh.html#a83f7221925f088f8fc0ce8267ef21e8" title="Flag for RecordSet::init().">MCS_RS_KNOW_NROWS</a>;
<a name="l00583"></a>00583     <span class="keywordflow">if</span> (<a class="code" href="classmcs_1_1FITSReader.html#4bfbbc2de8b807cd326bad7e01695879">local</a>)
<a name="l00584"></a>00584       i |= <a class="code" href="mcs_8hh.html#c9028cf078aadd3a410ed726a1f1d712" title="Flag for RecordSet::init().">MCS_RS_RANDOM</a>;
<a name="l00585"></a>00585 
<a name="l00586"></a>00586     <a class="code" href="classmcs_1_1RecordSet.html#7ad78f2b532392d093cae63df0a4a8bd" title="Initailize the Record set.">init</a>(i, <a class="code" href="classmcs_1_1FITSReader.html#e1f86d5c8b0eb0e0d2826a19713ca4f7">nrows</a>, &amp;meta);
<a name="l00587"></a>00587     <a class="code" href="classmcs_1_1RecordSet.html#7037ac062a737caad2a0223d2e5be71a" title="Must be called when record fetching is possible.">startFetch</a>();
<a name="l00588"></a>00588   }
<a name="l00589"></a>00589   <span class="keywordflow">else</span> {  <span class="comment">//Empty recordset</span>
<a name="l00590"></a>00590     i = <a class="code" href="mcs_8hh.html#6726a293d6d91ce8ea49f5fa4f7116bc" title="Flag for RecordSet::init().">MCS_RS_USEMETAREC</a> | <a class="code" href="mcs_8hh.html#a83f7221925f088f8fc0ce8267ef21e8" title="Flag for RecordSet::init().">MCS_RS_KNOW_NROWS</a>;
<a name="l00591"></a>00591     <a class="code" href="classmcs_1_1RecordSet.html#7ad78f2b532392d093cae63df0a4a8bd" title="Initailize the Record set.">init</a>(i, 0, &amp;meta);
<a name="l00592"></a>00592   }
<a name="l00593"></a>00593 }
<a name="l00594"></a>00594 
<a name="l00595"></a>00595 <span class="comment">//static FILE* _origstdin_ = stdin;</span>
<a name="l00596"></a>00596 
<a name="l00597"></a>00597 <span class="comment">//int fits_open_pipe(fitsfile** fptr, int filedes, int rwmode, int* status)</span>
<a name="l00598"></a>00598 <span class="comment">//{</span>
<a name="l00599"></a>00599 <span class="comment">//  if (filedes == 0)</span>
<a name="l00600"></a>00600 <span class="comment">//    stdin = _origstdin_;</span>
<a name="l00601"></a>00601 <span class="comment">//  else</span>
<a name="l00602"></a>00602 <span class="comment">//    _origstdin_ = fdopen(filedes, "r");</span>
<a name="l00603"></a>00603 <span class="comment">//</span>
<a name="l00604"></a>00604 <span class="comment">//  return fits_open_file(fptr, "-", READONLY, status);</span>
<a name="l00605"></a>00605 <span class="comment">//}</span>
<a name="l00606"></a>00606 
<a name="l00607"></a>00607 
<a name="l00608"></a>00608 <span class="comment">//void FITSReader::open(int fd)</span>
<a name="l00609"></a>00609 <span class="comment">//{</span>
<a name="l00610"></a>00610 <span class="comment">//  int status = 0;</span>
<a name="l00611"></a>00611 <span class="comment">//  fitsfile *fptr;</span>
<a name="l00612"></a>00612 <span class="comment">//</span>
<a name="l00613"></a>00613 <span class="comment">//  fits_open_pipe(&amp;fptr, fd, READONLY, &amp;status);</span>
<a name="l00614"></a>00614 <span class="comment">//  CHECK_FITS_ERROR;</span>
<a name="l00615"></a>00615 <span class="comment">//  this-&gt;fptr = fptr;</span>
<a name="l00616"></a>00616 <span class="comment">//</span>
<a name="l00617"></a>00617 <span class="comment">//  fits_get_num_hdus(fptr, &amp;nhdu, &amp;status);</span>
<a name="l00618"></a>00618 <span class="comment">//  CHECK_FITS_ERROR;</span>
<a name="l00619"></a>00619 <span class="comment">//</span>
<a name="l00620"></a>00620 <span class="comment">//  selectHDU(1);</span>
<a name="l00621"></a>00621 <span class="comment">//}</span>
<a name="l00622"></a>00622 
<a name="l00623"></a>00623 
<a name="l00624"></a>00624 <span class="comment">//static FILE* _origstdin_ = stdin;</span>
<a name="l00625"></a>00625 
<a name="l00626"></a><a class="code" href="classmcs_1_1FITSReader.html#8fd5c8d66c70402f453c1346013906aa">00626</a> <span class="keywordtype">void</span> <a class="code" href="classmcs_1_1FITSReader.html#8fd5c8d66c70402f453c1346013906aa">FITSReader::open</a>(<a class="code" href="classmcs_1_1Buffer.html" title="High level buffer.">Buffer</a>&amp; buf)
<a name="l00627"></a>00627 {
<a name="l00628"></a>00628   <span class="keywordtype">int</span> status;
<a name="l00629"></a>00629   fitsfile *<a class="code" href="classmcs_1_1FITSReader.html#fe7dc3c64af4d5578b906a0a6922f513">fptr</a>;
<a name="l00630"></a>00630 
<a name="l00631"></a>00631   <a class="code" href="classmcs_1_1FITSReader.html#8ed64c40983833ce695e3c9f4c9f4a9e">memfile</a>.<a class="code" href="classmcs_1_1Buffer.html#4c522e0015fd384cb838fd50f99a1cba">set</a>(buf[0], buf.<a class="code" href="classmcs_1_1Buffer.html#deec0575702c78ce384c9cf995a2bacd" title="Return size of the buffer.">size</a>(), <a class="code" href="namespacemcs.html#92ce752ad81ac31a04624a3fc580173011c897691e03531db0ea127460b02f33">AUTO_FREE</a>);
<a name="l00632"></a>00632 
<a name="l00633"></a>00633   <a class="code" href="classmcs_1_1FITSReader.html#835609513d1b3ffa4e0055a45ef80464">memfilep</a> = <a class="code" href="classmcs_1_1FITSReader.html#8ed64c40983833ce695e3c9f4c9f4a9e">memfile</a>[0];
<a name="l00634"></a>00634   <a class="code" href="classmcs_1_1FITSReader.html#e9dcb433bff0e323df341ff6e7508a13">memfilesize</a> = <a class="code" href="classmcs_1_1FITSReader.html#8ed64c40983833ce695e3c9f4c9f4a9e">memfile</a>.<a class="code" href="classmcs_1_1Buffer.html#deec0575702c78ce384c9cf995a2bacd" title="Return size of the buffer.">size</a>();
<a name="l00635"></a>00635   fits_open_memfile(&amp;fptr, <span class="stringliteral">"mem.fits"</span>, READONLY,
<a name="l00636"></a>00636             &amp;<a class="code" href="classmcs_1_1FITSReader.html#835609513d1b3ffa4e0055a45ef80464">memfilep</a>, &amp;<a class="code" href="classmcs_1_1FITSReader.html#e9dcb433bff0e323df341ff6e7508a13">memfilesize</a>,
<a name="l00637"></a>00637             0, NULL, &amp;status);
<a name="l00638"></a>00638 
<a name="l00639"></a>00639   CHECK_FITS_ERROR;
<a name="l00640"></a>00640   this-&gt;fptr = fptr;
<a name="l00641"></a>00641 
<a name="l00642"></a>00642   fits_get_num_hdus(fptr, &amp;<a class="code" href="classmcs_1_1FITSReader.html#a449a4fb6ba0da4621c60070c6804c14">nhdu</a>, &amp;status);
<a name="l00643"></a>00643   CHECK_FITS_ERROR;
<a name="l00644"></a>00644 
<a name="l00645"></a>00645   <a class="code" href="classmcs_1_1FITSReader.html#391803d7ba4764431babba17a220f089">selectHDU</a>(1);
<a name="l00646"></a>00646 }
<a name="l00647"></a>00647 
<a name="l00648"></a>00648 
<a name="l00649"></a>00649 
<a name="l00650"></a>00650 
<a name="l00651"></a><a class="code" href="classmcs_1_1FITSReader.html#147d48d7335044cfc9bfbd95aacf7fec">00651</a> <span class="keywordtype">void</span> <a class="code" href="classmcs_1_1FITSReader.html#8fd5c8d66c70402f453c1346013906aa">FITSReader::open</a>(<span class="keywordtype">string</span> fn)
<a name="l00652"></a>00652 {
<a name="l00653"></a>00653   <span class="keywordtype">int</span> status;
<a name="l00654"></a>00654   fitsfile *<a class="code" href="classmcs_1_1FITSReader.html#fe7dc3c64af4d5578b906a0a6922f513">fptr</a>;
<a name="l00655"></a>00655 
<a name="l00656"></a>00656   <a class="code" href="classmcs_1_1FITSReader.html#4bfbbc2de8b807cd326bad7e01695879">local</a> = <a class="code" href="classmcs_1_1URLReader.html#98d90e9e0ab8a3a5c88eab090789b788">URLReader::chkLocal</a>(fn);
<a name="l00657"></a>00657   <span class="comment">//local = false;</span>
<a name="l00658"></a>00658 
<a name="l00659"></a>00659   status = 0;
<a name="l00660"></a>00660   <span class="comment">//if (local) {</span>
<a name="l00661"></a>00661   <span class="keywordflow">if</span> (<a class="code" href="classmcs_1_1FITSReader.html#4bfbbc2de8b807cd326bad7e01695879">local</a> &amp;&amp; this-&gt;ffile_is_compressed(fn)) {
<a name="l00662"></a>00662     fits_open_file(&amp;fptr, fn.c_str(), READONLY, &amp;status);
<a name="l00663"></a>00663   }
<a name="l00664"></a>00664   <span class="keywordflow">else</span> {
<a name="l00665"></a>00665     <span class="comment">//The FITSReader can read also remote files (using its parent class</span>
<a name="l00666"></a>00666     <span class="comment">//URLReader). Note that CFITSIO cannot read a FITS file as a</span>
<a name="l00667"></a>00667     <span class="comment">//stream so actually it is entirely loaded into memory and then</span>
<a name="l00668"></a>00668     <span class="comment">//parsed.</span>
<a name="l00669"></a>00669 
<a name="l00670"></a>00670     <span class="comment">//Open the remote file as a file descriptor</span>
<a name="l00671"></a>00671     <a class="code" href="classmcs_1_1URLReader.html" title="A class that provide a uniform access to file retrieving.">URLReader</a> url;
<a name="l00672"></a>00672     <span class="keywordtype">int</span> fd = url.<a class="code" href="classmcs_1_1URLReader.html#1446986f340c93fbe17fea26cebb5f85" title="Obtain a file descriptor to read the file passed as parameter.">OpenAsFD</a>(fn.c_str());
<a name="l00673"></a>00673     <span class="keywordtype">int</span> n;
<a name="l00674"></a>00674     <span class="keywordtype">char</span> tmp[8192];
<a name="l00675"></a>00675 
<a name="l00676"></a>00676     <span class="comment">//Load the FITS file into memory</span>
<a name="l00677"></a>00677     <a class="code" href="classmcs_1_1FITSReader.html#8ed64c40983833ce695e3c9f4c9f4a9e">memfile</a>.<a class="code" href="classmcs_1_1Buffer.html#d884c6ac3fe4f03a291fda19fceea32b" title="Free allocated buffer.">free</a>();
<a name="l00678"></a>00678     <span class="keywordflow">while</span> ((n = read(fd, tmp, 8192)))
<a name="l00679"></a>00679     <a class="code" href="classmcs_1_1FITSReader.html#8ed64c40983833ce695e3c9f4c9f4a9e">memfile</a>(n) &lt;&lt; tmp;
<a name="l00680"></a>00680 
<a name="l00681"></a>00681     <a class="code" href="classmcs_1_1FITSReader.html#835609513d1b3ffa4e0055a45ef80464">memfilep</a> = <a class="code" href="classmcs_1_1FITSReader.html#8ed64c40983833ce695e3c9f4c9f4a9e">memfile</a>[0];
<a name="l00682"></a>00682     <a class="code" href="classmcs_1_1FITSReader.html#e9dcb433bff0e323df341ff6e7508a13">memfilesize</a> = <a class="code" href="classmcs_1_1FITSReader.html#8ed64c40983833ce695e3c9f4c9f4a9e">memfile</a>.<a class="code" href="classmcs_1_1Buffer.html#deec0575702c78ce384c9cf995a2bacd" title="Return size of the buffer.">size</a>();
<a name="l00683"></a>00683     fits_open_memfile(&amp;fptr, <span class="stringliteral">"mem.fits"</span>, READONLY,
<a name="l00684"></a>00684               &amp;<a class="code" href="classmcs_1_1FITSReader.html#835609513d1b3ffa4e0055a45ef80464">memfilep</a>, &amp;<a class="code" href="classmcs_1_1FITSReader.html#e9dcb433bff0e323df341ff6e7508a13">memfilesize</a>,
<a name="l00685"></a>00685               0, NULL, &amp;status);
<a name="l00686"></a>00686 
<a name="l00688"></a>00688     <span class="comment">//stdin = fdopen(fd, "r");</span>
<a name="l00689"></a>00689     <span class="comment">//</span>
<a name="l00691"></a>00691 <span class="comment"></span>    <span class="comment">//fits_open_file(&amp;fptr, "-", READONLY, &amp;status);</span>
<a name="l00692"></a>00692     <span class="comment">//</span>
<a name="l00694"></a>00694 <span class="comment"></span>    <span class="comment">//stdin = _origstdin_;</span>
<a name="l00695"></a>00695 
<a name="l00696"></a>00696     <span class="comment">//Close the remote file descriptor. If an error occurred during timeout</span>
<a name="l00697"></a>00697     <span class="comment">//an exception will be thrown here.</span>
<a name="l00698"></a>00698     url.<a class="code" href="classmcs_1_1URLReader.html#baf12623435804bfe109ee2447648572" title="Terminates a file retrieval.">Close</a>();
<a name="l00699"></a>00699   }
<a name="l00700"></a>00700 
<a name="l00701"></a>00701   CHECK_FITS_ERROR;
<a name="l00702"></a>00702   this-&gt;fptr = fptr;
<a name="l00703"></a>00703 
<a name="l00704"></a>00704   fits_get_num_hdus(fptr, &amp;<a class="code" href="classmcs_1_1FITSReader.html#a449a4fb6ba0da4621c60070c6804c14">nhdu</a>, &amp;status);
<a name="l00705"></a>00705   CHECK_FITS_ERROR;
<a name="l00706"></a>00706 
<a name="l00707"></a>00707   <a class="code" href="classmcs_1_1FITSReader.html#391803d7ba4764431babba17a220f089">selectHDU</a>(1);
<a name="l00708"></a>00708 }
<a name="l00709"></a>00709 
<a name="l00710"></a>00710 
<a name="l00711"></a>00711 
<a name="l00712"></a><a class="code" href="classmcs_1_1FITSReader.html#a87777af0ef207fbc084feb9f23e38f0">00712</a> <span class="keywordtype">bool</span> <a class="code" href="classmcs_1_1FITSReader.html#a87777af0ef207fbc084feb9f23e38f0">FITSReader::fetch</a>(<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> newpos, <span class="keywordtype">bool</span> random)
<a name="l00713"></a>00713 {
<a name="l00714"></a>00714   <span class="keywordtype">int</span> i, status = 0;
<a name="l00715"></a>00715   fitsfile *<a class="code" href="classmcs_1_1FITSReader.html#fe7dc3c64af4d5578b906a0a6922f513">fptr</a> = (fitsfile*) this-&gt;fptr;
<a name="l00716"></a>00716 
<a name="l00717"></a>00717   if (newpos &gt;= <a class="code" href="classmcs_1_1FITSReader.html#e1f86d5c8b0eb0e0d2826a19713ca4f7">nrows</a>)
<a name="l00718"></a>00718     <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00719"></a>00719 
<a name="l00720"></a>00720   <span class="keywordflow">for</span> (i=0; i&lt;<a class="code" href="classmcs_1_1FITSReader.html#8e545d6972e59479b8e03a3d64f465d3">ncols</a>; i++) {
<a name="l00721"></a>00721     <span class="keywordtype">void</span>* p = <a class="code" href="classmcs_1_1RecordSet.html#00c400d11a2610e3eee0111897c82c4d">rec</a>()[i].buffer();
<a name="l00722"></a>00722     <span class="keywordtype">int</span> fitstype;
<a name="l00723"></a>00723     <span class="keywordtype">int</span> isnull;
<a name="l00724"></a>00724 
<a name="l00725"></a>00725     <a class="code" href="namespacemcs.html#717605cd083f53e1428a04ea53cb18f6" title="Convert a MCS type into a FITSIO type.">Types2FITS</a>(<a class="code" href="classmcs_1_1RecordSet.html#00c400d11a2610e3eee0111897c82c4d">rec</a>()[i].type(), <a class="code" href="classmcs_1_1RecordSet.html#00c400d11a2610e3eee0111897c82c4d">rec</a>()[i].isUnsigned(), fitstype);
<a name="l00726"></a>00726 
<a name="l00727"></a>00727     fits_read_col(fptr, fitstype, i+1, newpos+1, 1, 1, NULL,
<a name="l00728"></a>00728           (<a class="code" href="namespacemcs.html#1d2fda0d77c15f3b7d150807ca78148e" title="Tell if &amp;quot;type&amp;quot; is a variable length type.">VarLenType</a>(<a class="code" href="classmcs_1_1RecordSet.html#00c400d11a2610e3eee0111897c82c4d">rec</a>()[i].type())  ?   &amp;p   :   p),
<a name="l00729"></a>00729           &amp;isnull, &amp;status);
<a name="l00730"></a>00730     CHECK_FITS_ERROR;
<a name="l00731"></a>00731 
<a name="l00732"></a>00732     <a class="code" href="classmcs_1_1RecordSet.html#00c400d11a2610e3eee0111897c82c4d">rec</a>()[i].<a class="code" href="classmcs_1_1Record.html#5a507f30e25d622a099827fc1b2e64f5" title="Set all Data object&amp;#39;s name to null values.">setNull</a>(isnull);
<a name="l00733"></a>00733   }
<a name="l00734"></a>00734 
<a name="l00735"></a>00735   <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00736"></a>00736 }
<a name="l00737"></a>00737 
<a name="l00738"></a>00738 
<a name="l00739"></a><a class="code" href="classmcs_1_1FITSReader.html#7dd597965e95115cecd96ac165589b12">00739</a> <span class="keywordtype">void</span> <a class="code" href="classmcs_1_1FITSReader.html#7dd597965e95115cecd96ac165589b12">FITSReader::close</a>() {
<a name="l00740"></a>00740   <span class="keywordtype">int</span> status = 0;
<a name="l00741"></a>00741   fitsfile *<a class="code" href="classmcs_1_1FITSReader.html#fe7dc3c64af4d5578b906a0a6922f513">fptr</a> = (fitsfile*) this-&gt;fptr;
<a name="l00742"></a>00742 
<a name="l00743"></a>00743   if (fptr) {
<a name="l00744"></a>00744     fits_close_file(fptr, &amp;status);
<a name="l00745"></a>00745     fptr = NULL;
<a name="l00746"></a>00746     CHECK_FITS_ERROR;
<a name="l00747"></a>00747   }
<a name="l00748"></a>00748 }
<a name="l00749"></a>00749 
<a name="l00750"></a><a class="code" href="classmcs_1_1FITSReader.html#e0560b47093b44ea6cb75c3f64b1040c">00750</a> <span class="keywordtype">bool</span> <a class="code" href="classmcs_1_1FITSReader.html#e0560b47093b44ea6cb75c3f64b1040c">FITSReader::ffile_is_compressed</a>(<span class="keywordtype">string</span> fn) {
<a name="l00751"></a>00751   <span class="keywordtype">char</span> buf[2];
<a name="l00752"></a>00752 
<a name="l00753"></a>00753   <span class="keywordflow">try</span> {
<a name="l00754"></a>00754     std::ifstream in(fn.c_str(), ios_base::in | ios_base::binary);
<a name="l00755"></a>00755 
<a name="l00756"></a>00756     in.read(&amp;buf[0], 2);
<a name="l00757"></a>00757 
<a name="l00758"></a>00758     in.close();
<a name="l00759"></a>00759 
<a name="l00760"></a>00760     <span class="keywordflow">if</span> ( (memcmp(buf, <span class="stringliteral">"\037\213"</span>, 2) == 0) ||  <span class="comment">/* GZIP  */</span>
<a name="l00761"></a>00761          (memcmp(buf, <span class="stringliteral">"\120\113"</span>, 2) == 0) ||  <span class="comment">/* PKZIP */</span>
<a name="l00762"></a>00762          (memcmp(buf, <span class="stringliteral">"\037\036"</span>, 2) == 0) ||  <span class="comment">/* PACK  */</span>
<a name="l00763"></a>00763          (memcmp(buf, <span class="stringliteral">"\037\235"</span>, 2) == 0) ||  <span class="comment">/* LZW   */</span>
<a name="l00764"></a>00764          (memcmp(buf, <span class="stringliteral">"\037\240"</span>, 2) == 0) )   <span class="comment">/* LZH   */</span>
<a name="l00765"></a>00765     {
<a name="l00766"></a>00766       <span class="keywordflow">return</span> <span class="keyword">true</span>;  <span class="comment">/* compressed file */</span>
<a name="l00767"></a>00767     } <span class="keywordflow">else</span> {
<a name="l00768"></a>00768       <span class="keywordflow">return</span> <span class="keyword">false</span>;  <span class="comment">/* not a compressed file */</span>
<a name="l00769"></a>00769     }
<a name="l00770"></a>00770   } <span class="keywordflow">catch</span>(<a class="code" href="classmcs_1_1Event.html" title="Hold informations about an event.">Event</a>&amp; e) {
<a name="l00771"></a>00771     cerr &lt;&lt;<span class="stringliteral">"ffile_is_compressed: "</span>&lt;&lt; e.<a class="code" href="classmcs_1_1Event.html#e52bdf8d42216e800bbd66cd58b949e4" title="Returns the message.">msg</a>() &lt;&lt; endl;
<a name="l00772"></a>00772     <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00773"></a>00773   }
<a name="l00774"></a>00774 
<a name="l00775"></a>00775 }
<a name="l00776"></a>00776 <span class="preprocessor">#endif //ENABLE_CFITSIO</span>
<a name="l00777"></a>00777 <span class="preprocessor"></span>
<a name="l00778"></a>00778 
<a name="l00779"></a>00779 
<a name="l00780"></a>00780 
<a name="l00781"></a>00781 
<a name="l00782"></a>00782 
<a name="l00783"></a>00783 <span class="comment">//FileReader::FileReader() : RecordSet()</span>
<a name="l00784"></a>00784 <span class="comment">//{</span>
<a name="l00785"></a>00785 <span class="comment">//  fd = 0;</span>
<a name="l00786"></a>00786 <span class="comment">//}</span>
<a name="l00787"></a>00787 <span class="comment">//</span>
<a name="l00788"></a>00788 <span class="comment">//FileReader::~FileReader()</span>
<a name="l00789"></a>00789 <span class="comment">//{</span>
<a name="l00790"></a>00790 <span class="comment">//  this-&gt;close();</span>
<a name="l00791"></a>00791 <span class="comment">//}</span>
<a name="l00792"></a>00792 <span class="comment">//</span>
<a name="l00793"></a>00793 <span class="comment">//void FileReader::open(string url)</span>
<a name="l00794"></a>00794 <span class="comment">//{</span>
<a name="l00795"></a>00795 <span class="comment">//  this-&gt;close();</span>
<a name="l00796"></a>00796 <span class="comment">//</span>
<a name="l00797"></a>00797 <span class="comment">//  if (master.count() == 0)</span>
<a name="l00798"></a>00798 <span class="comment">//    throw;</span>
<a name="l00799"></a>00799 <span class="comment">//</span>
<a name="l00800"></a>00800 <span class="comment">//  fd = input.OpenAsFD(url);</span>
<a name="l00801"></a>00801 <span class="comment">//  init(0);</span>
<a name="l00802"></a>00802 <span class="comment">//  startFetch();</span>
<a name="l00803"></a>00803 <span class="comment">//}</span>
<a name="l00804"></a>00804 <span class="comment">//</span>
<a name="l00805"></a>00805 <span class="comment">//</span>
<a name="l00806"></a>00806 <span class="comment">//bool FileReader::fetch(unsigned int newpos, bool random)</span>
<a name="l00807"></a>00807 <span class="comment">//{</span>
<a name="l00808"></a>00808 <span class="comment">//  if (sep.length() &gt; 0) {   //Variable length record</span>
<a name="l00809"></a>00809 <span class="comment">//    ;</span>
<a name="l00810"></a>00810 <span class="comment">//</span>
<a name="l00811"></a>00811 <span class="comment">//  }</span>
<a name="l00812"></a>00812 <span class="comment">//  else {  //Fixed length record</span>
<a name="l00813"></a>00813 <span class="comment">//    size_t recsize = 0;</span>
<a name="l00814"></a>00814 <span class="comment">//    int i;</span>
<a name="l00815"></a>00815 <span class="comment">//    for (i=0; i&lt;master.count(); i++)  //Compute record size</span>
<a name="l00816"></a>00816 <span class="comment">//      recsize += master[i].maxLength();</span>
<a name="l00817"></a>00817 <span class="comment">//</span>
<a name="l00818"></a>00818 <span class="comment">//    buf.chkAllocation(recsize);</span>
<a name="l00819"></a>00819 <span class="comment">//    unsigned int size = read(fd, buf[0], recsize);</span>
<a name="l00820"></a>00820 <span class="comment">//</span>
<a name="l00821"></a>00821 <span class="comment">//    if (size &lt; recsize)</span>
<a name="l00822"></a>00822 <span class="comment">//      throw;</span>
<a name="l00823"></a>00823 <span class="comment">//</span>
<a name="l00824"></a>00824 <span class="comment">//    //Copy data into the current record object</span>
<a name="l00825"></a>00825 <span class="comment">//    rec() = master;</span>
<a name="l00826"></a>00826 <span class="comment">//    unsigned int cur = 0;</span>
<a name="l00827"></a>00827 <span class="comment">//    for (i=0; i&lt;master.count(); i++) {</span>
<a name="l00828"></a>00828 <span class="comment">//      buf(cur, rec()[i].maxLength()) &gt;&gt; rec()[i].buffer();</span>
<a name="l00829"></a>00829 <span class="comment">//      cur += rec()[i].maxLength();</span>
<a name="l00830"></a>00830 <span class="comment">//    }</span>
<a name="l00831"></a>00831 <span class="comment">//  }</span>
<a name="l00832"></a>00832 <span class="comment">//</span>
<a name="l00833"></a>00833 <span class="comment">//  return true;</span>
<a name="l00834"></a>00834 <span class="comment">//}</span>
<a name="l00835"></a>00835 <span class="comment">//</span>
<a name="l00836"></a>00836 <span class="comment">//void FileReader::close()</span>
<a name="l00837"></a>00837 <span class="comment">//{</span>
<a name="l00838"></a>00838 <span class="comment">//  sep = "";</span>
<a name="l00839"></a>00839 <span class="comment">//  eor = "";</span>
<a name="l00840"></a>00840 <span class="comment">//  master.clear();</span>
<a name="l00841"></a>00841 <span class="comment">//}</span>
<a name="l00842"></a>00842 <span class="comment">//</span>
<a name="l00843"></a>00843 <span class="comment">//void FileReader::setMaster(Record&amp; rec)</span>
<a name="l00844"></a>00844 <span class="comment">//{</span>
<a name="l00845"></a>00845 <span class="comment">//  sep = "";</span>
<a name="l00846"></a>00846 <span class="comment">//  eor = "";</span>
<a name="l00847"></a>00847 <span class="comment">//  master = rec;</span>
<a name="l00848"></a>00848 <span class="comment">//}</span>
<a name="l00849"></a>00849 <span class="comment">//</span>
<a name="l00850"></a>00850 <span class="comment">//void FileReader::setMaster(Record&amp; rec, string sep)</span>
<a name="l00851"></a>00851 <span class="comment">//{</span>
<a name="l00852"></a>00852 <span class="comment">//  this-&gt;sep = sep;</span>
<a name="l00853"></a>00853 <span class="comment">//  eor = "";</span>
<a name="l00854"></a>00854 <span class="comment">//  master = rec;</span>
<a name="l00855"></a>00855 <span class="comment">//}</span>
<a name="l00856"></a>00856 <span class="comment">//</span>
<a name="l00857"></a>00857 <span class="comment">//void FileReader::setMaster(Record&amp; rec, string sep, string eor)</span>
<a name="l00858"></a>00858 <span class="comment">//{</span>
<a name="l00859"></a>00859 <span class="comment">//  this-&gt;sep = sep;</span>
<a name="l00860"></a>00860 <span class="comment">//  this-&gt;eor = eor;</span>
<a name="l00861"></a>00861 <span class="comment">//  master = rec;</span>
<a name="l00862"></a>00862 <span class="comment">//}</span>
</pre></div><hr size="1">
<table border=0 bgcolor="9f95ff" width="100%">
  <tr>
    <td>
      <a href="http://ross.iasfbo.inaf.it/MCS/" target="_blank">
        <img src="mcslogo_ssss_c.gif" alt="mcslogo" align="left" border="0">
      </a>
    </td>
<!--
    <td>
    <p align="middle">
      <a href="http://ross.iasfbo.inaf.it/mcs/" target="_blank">
         MCS (My Customizable Server)
      </a>
      <br>
      <a href="mailto:Giorgio Calderone <gcalderone@ifc.inaf.it>">
         Giorgio Calderone
      </a>
    </p>
    </td>
    <td>
      <a href="mailto:Giorgio Calderone <gcalderone@ifc.inaf.it>">
        <img src="mcslogo_sss_c.gif" alt="giorgio" align="right" border="0">
      </a>
    </td>
-->
    <td>
        <p align="right">
	MCS (My Customizable Server) ver. 0.3.3-alpha4
	<br>
	Documentation generated on Sat Dec 15 11:05:44 UTC 2012
	</p>
    </td>
  </tr>
</table>
